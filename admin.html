<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧图书 - 管理控制台</title>
    <!-- 引入资源 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-demi"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <!-- ECharts 可视化图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 公共JS模块 -->
    <script src="./js/common.js"></script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .sidebar-menu {
            border-right: none !important;
            background-color: transparent !important;
        }

        .sidebar-menu .el-menu-item {
            border-radius: 8px;
            margin: 4px 8px;
            color: #94a3b8;
        }

        .sidebar-menu .el-menu-item.is-active {
            background-color: #4f46e5 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .sidebar-menu .el-menu-item:hover:not(.is-active) {
            background-color: #1e293b !important;
            color: white !important;
        }

        .custom-table .el-table__header th {
            background-color: #f8fafc !important;
            color: #475569;
            font-weight: 600;
        }

        .custom-table .el-table__row {
            transition: background 0.2s;
        }

        .stat-card-1 {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        .stat-card-2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card-4 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .cursor-pointer:hover {
            opacity: 0.95;
        }

        /* 消息列表悬停效果 */
        .notification-item {
            transition: background-color 0.2s;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>

<body>
    <div id="app"><router-view></router-view></div>

    <script>
        const { createApp, reactive, ref, computed, onMounted } = Vue;
        const { createRouter, createWebHashHistory, useRouter, useRoute } = VueRouter;
        const { createPinia, defineStore } = Pinia;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // --- API 配置 ---
        const { API_BASE_URL, formatTime, createHttpClient, handleImgError } = window.LibraryCommon;

        // HTTP 请求封装 (使用公共模块)
        const http = createHttpClient('admin_token_pro', 'admin_info_pro');

        // --- 后端 API ---
        const api = {
            // 登录
            async login(data) {
                const result = await http.post('/auth/login', data);
                // 映射后端返回的用户数据
                const roleMap = { 'ADMIN': '超级管理员', 'LIBRARIAN': '馆员', 'USER': '普通用户' };
                return {
                    token: result.token,
                    user: {
                        id: result.user.id,
                        username: result.user.username,
                        role: roleMap[result.user.role] || result.user.role,
                        rawRole: result.user.role,
                        avatar: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'
                    }
                };
            },
            // 获取统计数据
            async getStats() {
                const [booksResult, borrowsResult] = await Promise.all([
                    http.get('/books', { page: 1, size: 1 }),
                    http.get('/borrows', { page: 1, size: 1 })
                ]);
                return {
                    totalBooks: booksResult.total || 0,
                    totalStock: 0, // 需要后端支持
                    activeBorrows: borrowsResult.total || 0,
                    totalReviews: 0 // 评论功能暂未实现
                };
            },
            // 获取图书列表
            async getBooks(params = {}) {
                const result = await http.get('/books', { page: 1, size: 100, ...params });
                // 映射字段：后端 -> 前端
                return (result.list || []).map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    categoryName: book.categoryName,
                    stock: book.availableCount,
                    totalStock: book.totalCount,
                    cover: book.coverUrl || 'https://placehold.co/400x600/e2e8f0/475569?text=Cover',
                    price: book.price,
                    rating: 9.0,
                    desc: book.description,
                    date: book.createdAt ? book.createdAt.split('T')[0] : '',
                    isbn: book.isbn,
                    publisher: book.publisher,
                    location: book.location
                }));
            },
            // 新增图书
            async addBook(book) {
                await http.post('/books', {
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    totalCount: book.stock || 10,
                    price: book.price,
                    description: book.desc,
                    coverUrl: book.cover,
                    isbn: book.isbn || '',
                    publisher: book.publisher || '',
                    location: book.location || ''
                });
            },
            // 更新图书
            async updateBook(book) {
                await http.put(`/books/${book.id}`, {
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    totalCount: book.totalStock ?? book.stock ?? 0,
                    price: book.price ?? 0,
                    description: book.desc || '',
                    coverUrl: book.cover || '',
                    isbn: book.isbn || '',
                    publisher: book.publisher || '',
                    location: book.location || ''
                });
            },
            // 删除图书
            async deleteBook(id) {
                await http.delete(`/books/${id}`);
            },
            // 上传图书封面
            async uploadCover(file) {
                return await http.uploadFile('/files/upload', file);
            },
            // 获取分类列表
            async getCategories() {
                return await http.get('/categories');
            },
            // 获取分类树
            async getCategoryTree() {
                return await http.get('/categories/tree');
            },
            // 获取借阅记录
            async getBorrows(params = {}) {
                const result = await http.get('/borrows', { page: 1, size: 100, ...params });
                // 映射字段
                return (result.list || []).map(record => ({
                    id: record.id,
                    bookId: record.bookId,
                    bookTitle: record.bookTitle,
                    userId: record.userId,
                    username: record.username,
                    borrowDate: record.borrowDate ? record.borrowDate.split('T')[0] : '',
                    returnDate: record.returnDate ? record.returnDate.split('T')[0] : null,
                    dueDate: record.dueDate ? record.dueDate.split('T')[0] : '',
                    status: record.statusDesc,
                    overdue: record.overdue,
                    // 新增续借和罚款信息
                    renewCount: record.renewCount || 0,
                    overdueDays: record.overdueDays || 0,
                    fineAmount: record.fineAmount || 0,
                    finePaid: record.finePaid || false
                }));
            },
            // 归还图书
            async returnBook(id) {
                await http.post(`/borrows/${id}/return`);
            },
            // 获取用户列表（管理员）
            async getAdmins(params = {}) {
                const result = await http.get('/users', { page: 1, size: 100, ...params });
                const roleMap = { 'ADMIN': '超级管理员', 'LIBRARIAN': '馆员', 'USER': '普通用户' };
                return (result.list || []).map(user => ({
                    id: user.id,
                    username: user.username,
                    realName: user.realName,
                    email: user.email,
                    phone: user.phone,
                    role: roleMap[user.role] || user.role,
                    rawRole: user.role,
                    status: user.status,
                    avatar: 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png',
                    createdAt: user.createdAt ? user.createdAt.split('T')[0] : ''
                }));
            },
            // 新增管理员（注册）
            async addAdmin(admin) {
                await http.post('/auth/register', {
                    username: admin.username,
                    password: admin.password,
                    realName: admin.realName || admin.username,
                    email: admin.email || `${admin.username}@library.com`,
                    phone: admin.phone || ''
                });
            },
            // 删除用户
            async deleteAdmin(id) {
                await http.delete(`/users/${id}`);
            },
            // 更新用户状态
            async updateUserStatus(id, status) {
                await http.request(`/users/${id}/status?status=${status}`, { method: 'PUT' });
            },
            // 获取当前用户
            async getCurrentUser() {
                const user = await http.get('/auth/me');
                const roleMap = { 'ADMIN': '超级管理员', 'LIBRARIAN': '馆员', 'USER': '普通用户' };
                return {
                    id: user.id,
                    username: user.username,
                    role: roleMap[user.role] || user.role,
                    rawRole: user.role,
                    avatar: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'
                };
            },
            // 评论相关 API
            async getReviews(params = {}) {
                const result = await http.get('/reviews/admin', params);
                return {
                    list: (result.list || []).map(r => ({
                        id: r.id,
                        userId: r.userId,
                        username: r.username,
                        avatar: r.avatar || 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png',
                        bookId: r.bookId,
                        bookTitle: r.bookTitle,
                        rating: r.rating,
                        content: r.content,
                        likes: r.likes,
                        status: r.status,
                        createdAt: r.createdAt ? r.createdAt.replace('T', ' ').substring(0, 19) : ''
                    })),
                    total: result.total || 0
                };
            },
            async deleteReview(id) {
                return await http.delete(`/reviews/admin/${id}`);
            },
            async updateReviewStatus(id, status) {
                return await http.put(`/reviews/admin/${id}/status?status=${status}`, {});
            },
            // 配置相关（本地存储，后端暂无此接口）
            async getConfig() {
                return JSON.parse(localStorage.getItem('lib_sys_config_v3')) || {
                    sysName: '智慧图书 - 云端书城',
                    announcement: '欢迎来到智慧图书管理系统',
                    allowRegister: true,
                    maintenance: false
                };
            },
            async saveConfig(config) {
                localStorage.setItem('lib_sys_config_v3', JSON.stringify(config));
            },
            // 获取操作日志
            async getLogs(params = {}) {
                const result = await http.get('/logs', params);
                return {
                    list: (result.list || []).map(log => ({
                        id: log.id,
                        module: log.module,
                        operation: log.operation,
                        description: log.description,
                        method: log.method,
                        url: log.url,
                        params: log.params,
                        result: log.result,
                        operator: log.operator,
                        ipAddress: log.ipAddress,
                        operationTime: log.operationTime ? log.operationTime.replace('T', ' ').substring(0, 19) : '',
                        costTime: log.costTime,
                        status: log.status,
                        errorMsg: log.errorMsg
                    })),
                    total: result.total || 0,
                    page: result.page || 1,
                    size: result.size || 20
                };
            },
            // 通知相关 API
            async getNotifications(params = { page: 0, size: 20 }) {
                const result = await http.get('/notifications', params);
                const typeMap = {
                    'DUE_REMINDER': { label: '到期提醒', color: 'warning' },
                    'OVERDUE_NOTICE': { label: '逾期通知', color: 'danger' },
                    'RETURN_SUCCESS': { label: '归还成功', color: 'success' },
                    'BORROW_SUCCESS': { label: '借阅成功', color: 'success' },
                    'FINE_NOTICE': { label: '罚款通知', color: 'danger' },
                    'SYSTEM': { label: '系统通知', color: 'info' }
                };
                return {
                    list: (result.content || []).map(n => ({
                        id: n.id,
                        title: n.title,
                        content: n.content,
                        type: typeMap[n.type]?.color || 'info',
                        typeLabel: typeMap[n.type]?.label || '通知',
                        read: n.isRead,
                        borrowRecordId: n.borrowRecordId,
                        time: n.createdAt ? formatTime(n.createdAt) : ''
                    })),
                    total: result.totalElements || 0
                };
            },
            async getUnreadCount() {
                const result = await http.get('/notifications/unread-count');
                return result.count || 0;
            },
            async markNotificationRead(id) {
                await http.put(`/notifications/${id}/read`);
            },
            async markAllNotificationsRead() {
                await http.put('/notifications/read-all');
            },
            // 公告管理 API
            async getAnnouncements(params = {}) {
                return await http.get('/announcements', params);
            },
            async getAnnouncementById(id) {
                return await http.get(`/announcements/${id}`);
            },
            async createAnnouncement(data) {
                return await http.post('/announcements', data);
            },
            async updateAnnouncement(id, data) {
                return await http.put(`/announcements/${id}`, data);
            },
            async deleteAnnouncement(id) {
                return await http.delete(`/announcements/${id}`);
            },
            async publishAnnouncement(id) {
                return await http.post(`/announcements/${id}/publish`);
            },
            async unpublishAnnouncement(id) {
                return await http.post(`/announcements/${id}/unpublish`);
            },
            async toggleAnnouncementPin(id) {
                return await http.post(`/announcements/${id}/toggle-pin`);
            },
            // 高级统计 API
            async getAdvancedStatistics(params = {}) {
                return await http.get('/statistics/advanced', params);
            },
            // 仪表盘统计（后端统计接口）
            async getDashboardStats() {
                return await http.get('/statistics/dashboard');
            },
            // 用户审核相关 API
            async getPendingUsers(page = 1, size = 10) {
                return await http.get('/users/pending', { page, size });
            },
            async approveUser(id) {
                return await http.post(`/users/${id}/approve`);
            },
            async rejectUser(id) {
                return await http.post(`/users/${id}/reject`);
            },
            // 罚款规则 API
            async getFineRules() {
                return await http.get('/config/fine-rules');
            },
            async updateFineRules(data) {
                return await http.put('/config/fine-rules', data);
            },
            // 罚款记录 API
            async getFineRecords(params = {}) {
                return await http.get('/fines', params);
            },
            async getFineStatistics() {
                return await http.get('/fines/statistics');
            },
            async waiveFine(id, reason) {
                return await http.post(`/fines/${id}/waive`, { reason });
            },
            async payFine(id) {
                return await http.post(`/fines/${id}/pay`);
            }
        };

        // formatTime 函数已从公共模块导入,无需重复定义

        // --- Store ---
        const useAdminStore = defineStore('admin', () => {
            const token = ref(localStorage.getItem('admin_token_pro') || '');
            const userInfo = ref(JSON.parse(localStorage.getItem('admin_info_pro') || '{}'));

            const login = (data) => {
                token.value = data.token;
                userInfo.value = data.user;
                localStorage.setItem('admin_token_pro', data.token);
                localStorage.setItem('admin_info_pro', JSON.stringify(data.user));
            };
            const logout = () => {
                token.value = '';
                userInfo.value = {};
                localStorage.removeItem('admin_token_pro');
                localStorage.removeItem('admin_info_pro');
                window.location.reload();
            };

            const hasPermission = (allowedRoles) => {
                if (!allowedRoles || allowedRoles.length === 0) return true;
                return allowedRoles.includes(userInfo.value.role);
            };

            return { token, userInfo, login, logout, hasPermission };
        });

        // --- 页面组件 ---

        // 1. 登录页
        const Login = {
            template: `
                <div class="min-h-screen flex items-center justify-center bg-gray-900 relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1507842217121-9e93a5f63a81?auto=format&fit=crop&w=2000&q=80')] bg-cover opacity-20"></div>
                    <div class="bg-white p-10 rounded-2xl shadow-2xl w-96 relative z-10 animate__animated animate__fadeInUp">
                        <div class="text-center mb-8">
                            <div class="w-12 h-12 bg-indigo-600 rounded-lg flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
                                <el-icon size="24"><Management /></el-icon>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">后台管理系统</h2>
                            <p class="text-gray-500 text-sm mt-1">智慧图书 Cloud Admin</p>
                        </div>
                        <el-form size="large" @submit.prevent="handleLogin">
                            <el-form-item>
                                <el-input v-model="form.username" placeholder="管理员账号" prefix-icon="User" />
                            </el-form-item>
                            <el-form-item>
                                <el-input v-model="form.password" type="password" placeholder="密码" prefix-icon="Lock" show-password />
                            </el-form-item>
                            <el-button type="primary" class="w-full !rounded-lg !h-12 !text-lg !font-bold bg-indigo-600 hover:bg-indigo-700 border-none" :loading="loading" @click="handleLogin">
                                安全登录
                            </el-button>
                        </el-form>
                        <div class="mt-6 text-center text-xs text-gray-400">
                            默认账号: admin / admin123 (管理员) | librarian / admin123 (馆员)
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const router = useRouter(); const store = useAdminStore();
                const form = reactive({ username: '', password: '' });
                const loading = ref(false);
                const handleLogin = async () => {
                    if (!form.username || !form.password) return ElMessage.warning('请输入账号密码');
                    loading.value = true;
                    try {
                        const res = await api.login(form);
                        store.login(res);
                        ElMessage.success('登录成功');
                        router.push('/dashboard');
                    } catch (e) { ElMessage.error(e.message); }
                    finally { loading.value = false; }
                };
                return { form, handleLogin, loading };
            }
        };

        // 2. 仪表盘
        const Dashboard = {
            template: `
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">工作台概览</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div v-for="(stat, idx) in statsData" :key="idx" 
                             @click="navigateTo(stat.path)"
                             class="rounded-2xl p-6 text-white shadow-lg transform hover:-translate-y-1 transition-transform cursor-pointer"
                             :class="stat.bgClass"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-white/80 text-sm font-medium mb-1">{{stat.label}}</p>
                                    <h3 class="text-3xl font-bold">{{stat.value}}</h3>
                                </div>
                                <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                    <el-icon size="20"><component :is="stat.icon" /></el-icon>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs text-white/60">
                                <span>点击管理</span>
                                <el-icon class="ml-1"><Right /></el-icon>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-gray-800">最新入库</h3>
                                <el-button link type="primary" @click="$router.push('/books')">全部图书</el-button>
                            </div>
                            <el-table :data="recentBooks" style="width: 100%">
                                <el-table-column prop="title" label="书名" />
                                <el-table-column prop="author" label="作者" />
                                <el-table-column prop="categoryName" label="分类">
                                    <template #default="{row}">
                                        <el-tag size="small" effect="plain">{{ getCatName(row.categoryId) }}</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="stock" label="库存" width="100" />
                            </el-table>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4">系统公告</h3>
                            <div class="space-y-4">
                                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                    <h4 class="text-sm font-bold text-blue-800">当前角色：{{ store.userInfo.role }}</h4>
                                    <p class="text-xs text-blue-600 mt-1">
                                        <span v-if="store.userInfo.role === '超级管理员'">您拥有系统最高权限。</span>
                                        <span v-else-if="store.userInfo.role === '图书管理员'">您仅可进行图书与借阅操作。</span>
                                        <span v-else>您可以管理图书、借阅及社区评论。</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const router = useRouter();
                const store = useAdminStore();
                const stats = reactive({ totalBooks: 0, totalStock: 0, activeBorrows: 0, totalReviews: 0 });
                const recentBooks = ref([]);
                const categories = { 1: '前沿科技', 2: '经典文学', 3: '经管商业', 4: '历史人文' };

                const statsData = computed(() => {
                    const cards = [
                        { label: '馆藏种类', value: stats.totalBooks, icon: 'Collection', bgClass: 'stat-card-1', path: '/books', roles: ['超级管理员', '普通管理员', '图书管理员'] },
                        { label: '图书总库存', value: stats.totalStock, icon: 'Box', bgClass: 'stat-card-2', path: '/books', roles: ['超级管理员', '普通管理员', '图书管理员'] },
                        { label: '当前借出', value: stats.activeBorrows, icon: 'Timer', bgClass: 'stat-card-3', path: '/borrows', roles: ['超级管理员', '普通管理员', '图书管理员'] },
                        { label: '社区评论', value: stats.totalReviews, icon: 'ChatLineSquare', bgClass: 'stat-card-4', path: '/reviews', roles: ['超级管理员', '普通管理员'] },
                    ];
                    return cards.filter(c => c.roles.includes(store.userInfo.role));
                });

                const getCatName = (id) => categories[id] || '其他';
                const navigateTo = (path) => router.push(path);

                onMounted(async () => {
                    const s = await api.getStats();
                    Object.assign(stats, s);
                    const books = await api.getBooks();
                    recentBooks.value = books.slice(0, 5);
                });

                return { statsData, recentBooks, getCatName, navigateTo, store };
            }
        };

        // 3. 图书管理
        const BookManager = {
            template: `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">图书资料库</h2>
                        <el-button type="primary" icon="Plus" size="large" class="!rounded-lg" color="#4f46e5" @click="openDialog('add')">新增图书</el-button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex gap-4">
                            <el-input v-model="search" placeholder="搜索书名..." prefix-icon="Search" class="w-64" clearable />
                            <el-select v-model="filterCat" placeholder="全部分类" clearable>
                                <el-option v-for="cat in flatCategories" :key="cat.id" :label="cat.name" :value="cat.id" />
                            </el-select>
                        </div>
                        <el-table :data="filteredList" class="custom-table" size="large">
                            <el-table-column label="封面" width="100">
                                <template #default="{row}">
                                    <img :src="row.cover" class="w-12 h-16 object-cover rounded shadow-sm border border-gray-200" @error="(e) => handleImgError(e, 'cover')">
                                </template>
                            </el-table-column>
                            <el-table-column prop="title" label="书名" min-width="150" />
                            <el-table-column prop="author" label="作者" />
                            <el-table-column label="分类">
                                <template #default="{row}"><el-tag>{{ row.categoryName || getCatName(row.categoryId) }}</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="price" label="价格">
                                <template #default="{row}">¥{{ row.price }}</template>
                            </el-table-column>
                            <el-table-column label="库存" width="120">
                                <template #default="{row}">
                                    <el-tag :type="row.stock > 5 ? 'success' : (row.stock > 0 ? 'warning' : 'danger')">
                                        {{ row.stock }} 本
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="200" fixed="right">
                                <template #default="{row}">
                                    <el-button link type="primary" @click="openDialog('edit', row)">编辑</el-button>
                                    <el-button link type="danger" @click="handleDelete(row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <el-dialog v-model="dialogVisible" :title="dialogType === 'add' ? '入库新书' : '编辑信息'" width="600px" align-center class="!rounded-xl">
                        <el-form :model="form" label-width="80px" class="mt-4">
                            <el-form-item label="书名"><el-input v-model="form.title" /></el-form-item>
                            <el-form-item label="作者"><el-input v-model="form.author" /></el-form-item>
                            <el-form-item label="分类">
                                <el-cascader v-model="form.categoryPath" :options="categoryTree" :props="{value:'id',label:'name',children:'children',checkStrictly:true,emitPath:false}" clearable class="w-full" placeholder="选择分类" @change="onCategoryChange" />
                            </el-form-item>
                            <el-form-item label="ISBN"><el-input v-model="form.isbn" placeholder="图书ISBN" /></el-form-item>
                            <el-form-item label="封面">
                                <div class="flex gap-4 items-start w-full">
                                    <div class="flex-shrink-0">
                                        <el-upload
                                            class="cover-uploader"
                                            :show-file-list="false"
                                            :http-request="handleCoverUpload"
                                            accept="image/*"
                                        >
                                            <div v-if="form.cover" class="relative group">
                                                <img :src="form.cover" class="w-24 h-32 object-cover rounded border border-gray-200" />
                                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded">
                                                    <el-icon class="text-white text-xl"><Plus /></el-icon>
                                                </div>
                                            </div>
                                            <div v-else class="w-24 h-32 border-2 border-dashed border-gray-300 rounded flex flex-col items-center justify-center text-gray-400 hover:border-indigo-500 hover:text-indigo-500 transition-colors cursor-pointer">
                                                <el-icon class="text-2xl mb-1"><Plus /></el-icon>
                                                <span class="text-xs">上传封面</span>
                                            </div>
                                        </el-upload>
                                        <div v-if="uploading" class="text-xs text-indigo-500 mt-1">上传中...</div>
                                    </div>
                                    <div class="flex-1">
                                        <el-input v-model="form.cover" placeholder="或输入封面URL" class="mb-2" clearable />
                                        <p class="text-xs text-gray-400">支持 JPG、PNG 格式，建议尺寸 400x600</p>
                                    </div>
                                </div>
                            </el-form-item>
                            <div class="grid grid-cols-2 gap-4">
                                <el-form-item label="价格"><el-input-number v-model="form.price" :min="0" class="w-full" /></el-form-item>
                                <el-form-item label="库存"><el-input-number v-model="form.stock" :min="0" class="w-full" /></el-form-item>
                            </div>
                            <el-form-item label="简介"><el-input v-model="form.desc" type="textarea" :rows="3" /></el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="dialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="submitForm">保存提交</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const list = ref([]);
                const search = ref('');
                const filterCat = ref(null);
                const dialogVisible = ref(false);
                const dialogType = ref('add');
                const form = reactive({ id: null, title: '', author: '', categoryId: null, categoryPath: null, stock: 10, price: 50, cover: '', desc: '', isbn: '' });
                const categoryTree = ref([]);
                const flatCategories = ref([]);
                const uploading = ref(false);

                const load = async () => {
                    try {
                        list.value = await api.getBooks();
                    } catch (e) {
                        ElMessage.error(e.message);
                    }
                };

                const loadCategories = async () => {
                    try {
                        const tree = await api.getCategoryTree();
                        categoryTree.value = tree;
                        // 展平分类树用于筛选
                        const flatten = (cats, result = []) => {
                            cats.forEach(cat => {
                                result.push({ id: cat.id, name: cat.name });
                                if (cat.children && cat.children.length) flatten(cat.children, result);
                            });
                            return result;
                        };
                        flatCategories.value = flatten(tree);
                    } catch (e) {
                        console.error('加载分类失败', e);
                    }
                };

                const getCatName = (id) => {
                    const cat = flatCategories.value.find(c => c.id === id);
                    return cat ? cat.name : '其他';
                };

                const filteredList = computed(() => {
                    return list.value.filter(item => {
                        const matchName = item.title.includes(search.value) || item.author.includes(search.value);
                        const matchCat = filterCat.value ? item.categoryId === filterCat.value : true;
                        return matchName && matchCat;
                    });
                });

                const openDialog = (type, row) => {
                    dialogType.value = type;
                    dialogVisible.value = true;
                    if (type === 'edit') {
                        // 映射后端字段到前端 form 字段
                        // 注意：getBooks 已将 totalCount 映射为 totalStock，coverUrl 映射为 cover
                        form.id = row.id;
                        form.title = row.title;
                        form.author = row.author;
                        form.categoryId = row.categoryId;
                        form.categoryPath = row.categoryId;
                        form.stock = row.totalStock ?? row.totalCount ?? 0;
                        form.price = row.price ?? 0;
                        form.cover = row.cover || row.coverUrl || '';
                        form.desc = row.desc || row.description || '';
                        form.isbn = row.isbn || '';
                        form.publisher = row.publisher || '';
                        form.location = row.location || '';
                    } else {
                        Object.assign(form, { id: null, title: '', author: '', categoryId: null, categoryPath: null, stock: 10, price: 50, cover: '', desc: '', isbn: '' });
                    }
                };

                const onCategoryChange = (val) => {
                    form.categoryId = val;
                };

                const handleCoverUpload = async (options) => {
                    const file = options.file;
                    // 验证文件类型
                    if (!file.type.startsWith('image/')) {
                        ElMessage.error('请上传图片文件');
                        return;
                    }
                    // 验证文件大小（最大5MB）
                    if (file.size > 5 * 1024 * 1024) {
                        ElMessage.error('图片大小不能超过5MB');
                        return;
                    }
                    uploading.value = true;
                    try {
                        const result = await api.uploadCover(file);
                        form.cover = result.url || result;
                        ElMessage.success('封面上传成功');
                    } catch (e) {
                        ElMessage.error(e.message || '上传失败');
                    } finally {
                        uploading.value = false;
                    }
                };

                const submitForm = async () => {
                    if (!form.title || !form.author) return ElMessage.warning('请填写必要信息');
                    try {
                        if (dialogType.value === 'add') await api.addBook({ ...form });
                        else await api.updateBook({ ...form });
                        ElMessage.success('操作成功');
                        dialogVisible.value = false;
                        load();
                    } catch (e) {
                        ElMessage.error(e.message);
                    }
                };

                const handleDelete = async (row) => {
                    try {
                        await ElMessageBox.confirm(`确认删除《${row.title}》吗？`, '警告', { type: 'warning' });
                        await api.deleteBook(row.id);
                        ElMessage.success('已删除');
                        load();
                    } catch (e) {
                        if (e !== 'cancel') ElMessage.error(e.message);
                    }
                };

                onMounted(() => {
                    load();
                    loadCategories();
                });
                return { list, filteredList, search, filterCat, categoryTree, flatCategories, dialogVisible, dialogType, form, openDialog, submitForm, handleDelete, getCatName, onCategoryChange, uploading, handleCoverUpload, handleImgError };
            }
        };

        // 4. 借阅管理
        const BorrowManager = {
            template: `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">借阅记录管理</h2>
                        <el-button type="success" @click="handleExport" :loading="exporting">
                            <el-icon class="mr-1"><Download /></el-icon>导出 Excel
                        </el-button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="list" class="custom-table" size="large">
                            <el-table-column prop="id" label="订单号" width="100" />
                            <el-table-column prop="bookTitle" label="借阅图书" min-width="150" />
                            <el-table-column prop="username" label="用户" width="100" />
                            <el-table-column prop="borrowDate" label="借出日期" width="110" />
                            <el-table-column prop="dueDate" label="应还日期" width="110" />
                            <el-table-column prop="returnDate" label="归还日期" width="110">
                                <template #default="{row}">{{ row.returnDate || '-' }}</template>
                            </el-table-column>
                            <el-table-column label="状态" width="100">
                                <template #default="{row}">
                                    <el-tag :type="getStatusType(row)" effect="dark">{{ row.status }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="续借/罚款" width="150">
                                <template #default="{row}">
                                    <div class="flex flex-col gap-1">
                                        <span class="text-xs text-gray-500">续借: {{ row.renewCount }}/2次</span>
                                        <span v-if="row.fineAmount > 0" class="text-xs" :class="row.finePaid ? 'text-green-600' : 'text-red-600'">
                                            罚款: ¥{{ row.fineAmount.toFixed(2) }} {{ row.finePaid ? '(已缴)' : '(未缴)' }}
                                        </span>
                                        <span v-if="row.overdueDays > 0" class="text-xs text-orange-500">
                                            逾期: {{ row.overdueDays }}天
                                        </span>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="120" fixed="right">
                                <template #default="{row}">
                                    <el-button v-if="row.status === '借阅中'" type="primary" size="small" @click="handleReturn(row)">强制归还</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <div v-if="list.length === 0" class="p-10 text-center text-gray-400">暂无借阅记录</div>
                    </div>
                </div>
            `,
            setup() {
                const list = ref([]);
                const exporting = ref(false);
                const load = async () => list.value = await api.getBorrows();

                const getStatusType = (row) => {
                    if (row.status === '已归还') return 'success';
                    if (row.overdue) return 'danger';
                    return 'warning';
                };

                const handleReturn = async (row) => {
                    try {
                        await ElMessageBox.confirm(`确认强制归还订单 ${row.id} 吗？库存将自动恢复。`, '提示');
                        await api.returnBook(row.id);
                        ElMessage.success('操作成功');
                        load();
                    } catch { }
                };
                const handleExport = async () => {
                    try {
                        exporting.value = true;
                        const token = localStorage.getItem('admin_token_pro');
                        const response = await fetch(`${API_BASE_URL}/borrows/export`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) throw new Error('导出失败');
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let filename = '借阅记录.xlsx';
                        if (contentDisposition) {
                            const match = contentDisposition.match(/filename=(.+)/);
                            if (match) filename = decodeURIComponent(match[1]);
                        }
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        ElMessage.success('导出成功');
                    } catch (e) {
                        ElMessage.error('导出失败: ' + e.message);
                    } finally {
                        exporting.value = false;
                    }
                };
                onMounted(load);
                return { list, handleReturn, handleExport, exporting, getStatusType };
            }
        };

        // 5. 评论管理
        const ReviewManager = {
            template: `
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">社区评论管理</h2>

                    <!-- 搜索栏 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
                        <el-input v-model="keyword" placeholder="搜索评论内容、用户名、图书名..." clearable
                            @keyup.enter="loadReviews" style="width: 300px" class="mr-3">
                            <template #prefix><el-icon><Search /></el-icon></template>
                        </el-input>
                        <el-button type="primary" @click="loadReviews">搜索</el-button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="list" class="custom-table" size="large" v-loading="loading">
                            <el-table-column prop="username" label="用户" width="120">
                                <template #default="{row}">
                                    <div class="flex items-center gap-2">
                                        <el-avatar :size="24" :src="row.avatar"></el-avatar>
                                        <span class="truncate">{{row.username}}</span>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="bookTitle" label="图书" width="180" show-overflow-tooltip />
                            <el-table-column prop="content" label="评论内容" min-width="300" show-overflow-tooltip />
                            <el-table-column prop="rating" label="评分" width="100">
                                <template #default="{row}">
                                    <span style="color: #f7ba2a">{{ '★'.repeat(row.rating) }}</span>
                                    <span style="color: #ddd">{{ '★'.repeat(5 - row.rating) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="likes" label="点赞" width="80">
                                <template #default="{row}">
                                    <span class="text-pink-500">❤ {{ row.likes }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态" width="90">
                                <template #default="{row}">
                                    <el-tag :type="row.status === 1 ? 'success' : 'info'" size="small">
                                        {{ row.status === 1 ? '显示' : '隐藏' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="createdAt" label="时间" width="170" />
                            <el-table-column label="操作" width="150" fixed="right">
                                <template #default="{row}">
                                    <el-button v-if="row.status === 1" type="warning" size="small" @click="handleToggleStatus(row, 0)">隐藏</el-button>
                                    <el-button v-else type="success" size="small" @click="handleToggleStatus(row, 1)">显示</el-button>
                                    <el-button type="danger" size="small" icon="Delete" circle @click="handleDelete(row)"></el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <div v-if="!loading && list.length === 0" class="p-10 text-center text-gray-400">暂无评论数据</div>

                        <!-- 分页 -->
                        <div class="p-4 flex justify-end" v-if="total > 0">
                            <el-pagination
                                v-model:current-page="page"
                                v-model:page-size="size"
                                :total="total"
                                :page-sizes="[10, 20, 50]"
                                layout="total, sizes, prev, pager, next"
                                @size-change="loadReviews"
                                @current-change="loadReviews">
                            </el-pagination>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const list = ref([]);
                const loading = ref(false);
                const keyword = ref('');
                const page = ref(1);
                const size = ref(10);
                const total = ref(0);

                const loadReviews = async () => {
                    loading.value = true;
                    try {
                        const result = await api.getReviews({ keyword: keyword.value, page: page.value, size: size.value });
                        list.value = result.list;
                        total.value = result.total;
                    } catch (e) {
                        ElMessage.error('加载评论失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleDelete = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定删除这条评论吗？', '提示', { type: 'warning' });
                        await api.deleteReview(row.id);
                        ElMessage.success('已删除');
                        loadReviews();
                    } catch { }
                };

                const handleToggleStatus = async (row, status) => {
                    try {
                        await api.updateReviewStatus(row.id, status);
                        ElMessage.success(status === 1 ? '已显示' : '已隐藏');
                        loadReviews();
                    } catch (e) {
                        ElMessage.error('操作失败');
                    }
                };

                onMounted(loadReviews);
                return { list, loading, keyword, page, size, total, loadReviews, handleDelete, handleToggleStatus };
            }
        };

        // 6. 管理员管理
        const AdminManager = {
            template: `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">系统人员管理</h2>
                        <el-button type="primary" icon="Plus" size="large" class="!rounded-lg" color="#4f46e5" @click="dialogVisible = true">新增管理员</el-button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="list" class="custom-table" size="large">
                            <el-table-column label="用户" width="200">
                                <template #default="{row}">
                                    <div class="flex items-center gap-3">
                                        <el-avatar :src="row.avatar" />
                                        <div>
                                            <div class="font-bold">{{ row.username }}</div>
                                            <div class="text-xs text-gray-400">{{ row.realName || '-' }}</div>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="role" label="角色">
                                <template #default="{row}">
                                    <el-tag :type="row.role === '超级管理员' ? 'danger' : (row.role === '馆员' ? 'warning' : 'info')" effect="light">{{ row.role }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="email" label="邮箱" />
                            <el-table-column prop="createdAt" label="创建时间" width="120" />
                            <el-table-column label="状态" width="100">
                                <template #default="{row}">
                                    <el-tag type="success" effect="dark" v-if="row.status === 1">正常</el-tag>
                                    <el-tag type="danger" effect="dark" v-else>已禁用</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="180" fixed="right">
                                <template #default="{row}">
                                    <!-- 禁用/启用按钮 -->
                                    <el-button
                                        v-if="canToggleStatus(row)"
                                        :type="row.status === 1 ? 'warning' : 'success'"
                                        link
                                        @click="handleToggleStatus(row)"
                                    >
                                        {{ row.status === 1 ? '禁用' : '启用' }}
                                    </el-button>
                                    <!-- 删除按钮 -->
                                    <el-button
                                        v-if="row.rawRole !== 'ADMIN' && row.id !== currentAdminId"
                                        type="danger"
                                        link
                                        @click="handleDelete(row)"
                                    >
                                        删除
                                    </el-button>
                                    <span v-if="!canToggleStatus(row) && (row.rawRole === 'ADMIN' || row.id === currentAdminId)" class="text-gray-300 text-xs">不可操作</span>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <el-dialog v-model="dialogVisible" title="新增管理员" width="400px" align-center class="!rounded-xl">
                        <el-form :model="form" label-position="top">
                            <el-form-item label="登录账号"><el-input v-model="form.username" /></el-form-item>
                            <el-form-item label="初始密码"><el-input v-model="form.password" show-password /></el-form-item>
                            <el-form-item label="角色权限">
                                <el-select v-model="form.role" class="w-full">
                                    <el-option label="普通管理员" value="普通管理员" />
                                    <el-option label="图书管理员" value="图书管理员" />
                                </el-select>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="dialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="submitForm">创建账号</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const list = ref([]);
                const dialogVisible = ref(false);
                const form = reactive({ username: '', password: '', role: '普通管理员' });
                const store = useAdminStore();

                const load = async () => list.value = await api.getAdmins();

                // 判断是否可以切换状态
                const canToggleStatus = (row) => {
                    // 不能操作自己
                    if (row.id === store.userInfo.id) return false;
                    // 不能操作管理员账号
                    if (row.rawRole === 'ADMIN') return false;
                    return true;
                };

                // 切换用户状态
                const handleToggleStatus = async (row) => {
                    const newStatus = row.status === 1 ? 0 : 1;
                    const action = newStatus === 0 ? '禁用' : '启用';

                    try {
                        await ElMessageBox.confirm(
                            `确定${action}用户 "${row.username}" 吗？${newStatus === 0 ? '禁用后该用户将无法登录系统。' : ''}`,
                            '确认操作',
                            { type: newStatus === 0 ? 'warning' : 'info' }
                        );
                        await api.updateUserStatus(row.id, newStatus);
                        ElMessage.success(`${action}成功`);
                        load();
                    } catch (e) {
                        if (e !== 'cancel') ElMessage.error(e.message || '操作失败');
                    }
                };

                const submitForm = async () => {
                    if (!form.username || !form.password) return ElMessage.warning('请填写完整');
                    try {
                        await api.addAdmin({ ...form });
                        ElMessage.success('创建成功');
                        dialogVisible.value = false;
                        form.username = ''; form.password = '';
                        load();
                    } catch (e) { ElMessage.error(e.message); }
                };

                const handleDelete = async (row) => {
                    try {
                        await ElMessageBox.confirm(`确定删除用户 ${row.username} 吗？`, '警告', { type: 'warning' });
                        await api.deleteAdmin(row.id);
                        ElMessage.success('已删除');
                        load();
                    } catch (e) { if (e !== 'cancel') ElMessage.error(e.message); }
                };

                onMounted(load);
                return { list, dialogVisible, form, currentAdminId: store.userInfo.id, submitForm, handleDelete, canToggleStatus, handleToggleStatus };
            }
        };

        // 7. 用户审核管理
        const UserApprovalManager = {
            template: `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">用户注册审核</h1>
                        <el-button @click="loadData" :loading="loading">
                            <el-icon class="mr-1"><Refresh /></el-icon>刷新
                        </el-button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="list" class="custom-table" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="70" />
                            <el-table-column label="用户信息" min-width="200">
                                <template #default="{row}">
                                    <div class="flex items-center gap-3">
                                        <el-avatar :size="40" class="bg-indigo-500">{{ row.username?.charAt(0)?.toUpperCase() }}</el-avatar>
                                        <div>
                                            <div class="font-semibold text-gray-800">{{ row.username }}</div>
                                            <div class="text-xs text-gray-400">{{ row.realName || '未填写真实姓名' }}</div>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="email" label="邮箱" width="180">
                                <template #default="{row}">{{ row.email || '-' }}</template>
                            </el-table-column>
                            <el-table-column prop="phone" label="手机号" width="130">
                                <template #default="{row}">{{ row.phone || '-' }}</template>
                            </el-table-column>
                            <el-table-column label="申请时间" width="160">
                                <template #default="{row}">{{ formatDateTime(row.createdAt) }}</template>
                            </el-table-column>
                            <el-table-column label="操作" width="180" fixed="right">
                                <template #default="{row}">
                                    <el-button type="success" size="small" @click="handleApprove(row)">
                                        <el-icon class="mr-1"><Check /></el-icon>通过
                                    </el-button>
                                    <el-button type="danger" size="small" @click="handleReject(row)">
                                        <el-icon class="mr-1"><Close /></el-icon>拒绝
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                        <div v-if="!loading && list.length === 0" class="p-16 text-center">
                            <el-icon :size="48" class="text-gray-300 mb-4"><Checked /></el-icon>
                            <p class="text-gray-400">暂无待审核的用户</p>
                        </div>

                        <div v-if="total > 0" class="flex justify-end p-4 border-t">
                            <el-pagination
                                v-model:current-page="page"
                                v-model:page-size="pageSize"
                                :total="total"
                                :page-sizes="[10, 20, 50]"
                                layout="total, sizes, prev, pager, next"
                                @size-change="loadData"
                                @current-change="loadData"
                            />
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const loading = ref(false);
                const list = ref([]);
                const page = ref(1);
                const pageSize = ref(10);
                const total = ref(0);

                const formatDateTime = (str) => {
                    if (!str) return '-';
                    return str.replace('T', ' ').substring(0, 16);
                };

                const loadData = async () => {
                    loading.value = true;
                    try {
                        const result = await api.getPendingUsers(page.value, pageSize.value);
                        list.value = result.list || [];
                        total.value = result.total || 0;
                    } catch (e) {
                        ElMessage.error('加载失败: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const handleApprove = async (row) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定通过用户 "${row.username}" 的注册申请吗？`,
                            '审核确认',
                            { type: 'success', confirmButtonText: '通过', cancelButtonText: '取消' }
                        );
                        await api.approveUser(row.id);
                        ElMessage.success('审核通过');
                        loadData();
                    } catch (e) {
                        if (e !== 'cancel') ElMessage.error(e.message || '操作失败');
                    }
                };

                const handleReject = async (row) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定拒绝用户 "${row.username}" 的注册申请吗？拒绝后该账号将被删除。`,
                            '拒绝确认',
                            { type: 'warning', confirmButtonText: '拒绝', cancelButtonText: '取消' }
                        );
                        await api.rejectUser(row.id);
                        ElMessage.success('已拒绝');
                        loadData();
                    } catch (e) {
                        if (e !== 'cancel') ElMessage.error(e.message || '操作失败');
                    }
                };

                onMounted(loadData);

                return { loading, list, page, pageSize, total, formatDateTime, loadData, handleApprove, handleReject };
            }
        };

        // 8. 操作日志管理
        const LogManager = {
            template: `
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">操作日志</h2>

                    <!-- 筛选条件 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
                        <div class="flex flex-wrap gap-4 items-end">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">模块</label>
                                <el-select v-model="filters.module" placeholder="全部模块" clearable class="w-36">
                                    <el-option label="认证管理" value="认证管理" />
                                    <el-option label="图书管理" value="图书管理" />
                                    <el-option label="借阅管理" value="借阅管理" />
                                    <el-option label="用户管理" value="用户管理" />
                                    <el-option label="分类管理" value="分类管理" />
                                </el-select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">操作人</label>
                                <el-input v-model="filters.operator" placeholder="操作人" clearable class="w-32" />
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">时间范围</label>
                                <el-date-picker v-model="filters.dateRange" type="datetimerange" range-separator="至" start-placeholder="开始时间" end-placeholder="结束时间" value-format="YYYY-MM-DD HH:mm:ss" class="!w-80" />
                            </div>
                            <el-button type="primary" @click="loadLogs">查询</el-button>
                            <el-button @click="resetFilters">重置</el-button>
                        </div>
                    </div>

                    <!-- 日志列表 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="list" class="custom-table" size="large" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="80" />
                            <el-table-column prop="module" label="模块" width="100">
                                <template #default="{row}">
                                    <el-tag size="small" effect="plain">{{ row.module }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="operation" label="操作" width="80" />
                            <el-table-column prop="description" label="描述" min-width="120" show-overflow-tooltip />
                            <el-table-column prop="operator" label="操作人" width="100" />
                            <el-table-column prop="ipAddress" label="IP地址" width="130" />
                            <el-table-column prop="operationTime" label="操作时间" width="170" />
                            <el-table-column prop="costTime" label="耗时" width="80">
                                <template #default="{row}">{{ row.costTime }}ms</template>
                            </el-table-column>
                            <el-table-column label="状态" width="80">
                                <template #default="{row}">
                                    <el-tag :type="row.status === 1 ? 'success' : 'danger'" size="small">
                                        {{ row.status === 1 ? '成功' : '失败' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="80" fixed="right">
                                <template #default="{row}">
                                    <el-button link type="primary" @click="showDetail(row)">详情</el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- 分页 -->
                        <div class="p-4 flex justify-end">
                            <el-pagination
                                v-model:current-page="pagination.page"
                                v-model:page-size="pagination.size"
                                :total="pagination.total"
                                :page-sizes="[10, 20, 50, 100]"
                                layout="total, sizes, prev, pager, next"
                                @size-change="loadLogs"
                                @current-change="loadLogs"
                            />
                        </div>
                    </div>

                    <!-- 详情弹窗 -->
                    <el-dialog v-model="detailVisible" title="日志详情" width="700px" align-center>
                        <div v-if="selectedLog" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-gray-500 text-sm">模块</label>
                                    <div class="font-medium">{{ selectedLog.module }}</div>
                                </div>
                                <div>
                                    <label class="text-gray-500 text-sm">操作类型</label>
                                    <div class="font-medium">{{ selectedLog.operation }}</div>
                                </div>
                                <div>
                                    <label class="text-gray-500 text-sm">操作人</label>
                                    <div class="font-medium">{{ selectedLog.operator }}</div>
                                </div>
                                <div>
                                    <label class="text-gray-500 text-sm">IP地址</label>
                                    <div class="font-medium">{{ selectedLog.ipAddress }}</div>
                                </div>
                                <div>
                                    <label class="text-gray-500 text-sm">操作时间</label>
                                    <div class="font-medium">{{ selectedLog.operationTime }}</div>
                                </div>
                                <div>
                                    <label class="text-gray-500 text-sm">耗时</label>
                                    <div class="font-medium">{{ selectedLog.costTime }}ms</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-gray-500 text-sm">请求方法</label>
                                <div class="font-medium">{{ selectedLog.method }} {{ selectedLog.url }}</div>
                            </div>
                            <div>
                                <label class="text-gray-500 text-sm">描述</label>
                                <div class="font-medium">{{ selectedLog.description }}</div>
                            </div>
                            <div v-if="selectedLog.params">
                                <label class="text-gray-500 text-sm">请求参数</label>
                                <pre class="bg-gray-50 p-3 rounded-lg text-sm overflow-auto max-h-40">{{ formatJson(selectedLog.params) }}</pre>
                            </div>
                            <div v-if="selectedLog.status === 0 && selectedLog.errorMsg">
                                <label class="text-gray-500 text-sm text-red-500">错误信息</label>
                                <pre class="bg-red-50 text-red-600 p-3 rounded-lg text-sm overflow-auto max-h-40">{{ selectedLog.errorMsg }}</pre>
                            </div>
                        </div>
                        <template #footer>
                            <el-button type="primary" @click="detailVisible = false">关闭</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const list = ref([]);
                const loading = ref(false);
                const detailVisible = ref(false);
                const selectedLog = ref(null);

                const filters = reactive({
                    module: '',
                    operator: '',
                    dateRange: null
                });

                const pagination = reactive({
                    page: 1,
                    size: 20,
                    total: 0
                });

                const loadLogs = async () => {
                    loading.value = true;
                    try {
                        const params = {
                            page: pagination.page,
                            size: pagination.size
                        };
                        if (filters.module) params.module = filters.module;
                        if (filters.operator) params.operator = filters.operator;
                        if (filters.dateRange && filters.dateRange.length === 2) {
                            params.startTime = filters.dateRange[0];
                            params.endTime = filters.dateRange[1];
                        }

                        const result = await api.getLogs(params);
                        list.value = result.list;
                        pagination.total = result.total;
                    } catch (e) {
                        ElMessage.error(e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const resetFilters = () => {
                    filters.module = '';
                    filters.operator = '';
                    filters.dateRange = null;
                    pagination.page = 1;
                    loadLogs();
                };

                const showDetail = (row) => {
                    selectedLog.value = row;
                    detailVisible.value = true;
                };

                const formatJson = (str) => {
                    try {
                        return JSON.stringify(JSON.parse(str), null, 2);
                    } catch {
                        return str;
                    }
                };

                onMounted(loadLogs);

                return { list, loading, filters, pagination, detailVisible, selectedLog, loadLogs, resetFilters, showDetail, formatJson };
            }
        };

        // 8. 统计报表
        const StatisticsManager = {
            template: `
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">统计报表</h2>

                    <!-- 筛选条件 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
                        <div class="flex flex-wrap gap-4 items-end">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">时间范围</label>
                                <el-date-picker v-model="dateRange" type="daterange" range-separator="至" start-placeholder="开始日期" end-placeholder="结束日期" value-format="YYYY-MM-DD" class="!w-64" />
                            </div>
                            <el-button type="primary" @click="loadStatistics">查询</el-button>
                            <el-button @click="resetFilters">重置</el-button>
                        </div>
                    </div>

                    <!-- 汇总卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                            <p class="text-white/80 text-sm mb-1">期间借阅总数</p>
                            <h3 class="text-3xl font-bold">{{ stats.totalBorrows }}</h3>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
                            <p class="text-white/80 text-sm mb-1">期间归还总数</p>
                            <h3 class="text-3xl font-bold">{{ stats.totalReturns }}</h3>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg">
                            <p class="text-white/80 text-sm mb-1">逾期次数</p>
                            <h3 class="text-3xl font-bold">{{ stats.overdueCount }}</h3>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-6 text-white shadow-lg">
                            <p class="text-white/80 text-sm mb-1">罚款总额</p>
                            <h3 class="text-3xl font-bold">¥{{ stats.totalFines }}</h3>
                        </div>
                    </div>

                    <!-- ECharts 图表区域 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- 分类借阅占比饼图 -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-800 mb-4">图书分类借阅占比</h3>
                            <div ref="categoryPieChart" style="width: 100%; height: 350px;"></div>
                        </div>

                        <!-- 用户角色占比饼图 -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-800 mb-4">用户角色借阅分布</h3>
                            <div ref="rolePieChart" style="width: 100%; height: 350px;"></div>
                        </div>
                    </div>

                    <!-- 月度趋势折线图 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">月度借阅趋势</h3>
                        <div ref="monthlyLineChart" style="width: 100%; height: 400px;"></div>
                    </div>

                    <!-- 热门图书和活跃用户柱状图 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-800 mb-4">热门图书 TOP10</h3>
                            <div ref="hotBooksChart" style="width: 100%; height: 400px;"></div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-800 mb-4">活跃用户 TOP10</h3>
                            <div ref="activeUsersChart" style="width: 100%; height: 400px;"></div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const dateRange = ref(null);
                const stats = reactive({
                    totalBorrows: 0,
                    totalReturns: 0,
                    overdueCount: 0,
                    totalFines: '0.00',
                    categoryStats: [],
                    monthlyStats: [],
                    userRoleStats: [],
                    hotBooks: [],
                    activeUsers: []
                });

                // 图表DOM引用
                const categoryPieChart = ref(null);
                const rolePieChart = ref(null);
                const monthlyLineChart = ref(null);
                const hotBooksChart = ref(null);
                const activeUsersChart = ref(null);

                // ECharts 实例
                let categoryPieInstance = null;
                let rolePieInstance = null;
                let monthlyLineInstance = null;
                let hotBooksInstance = null;
                let activeUsersInstance = null;

                // 初始化图表
                const initCharts = () => {
                    try {
                        if (categoryPieChart.value) categoryPieInstance = echarts.init(categoryPieChart.value);
                        if (rolePieChart.value) rolePieInstance = echarts.init(rolePieChart.value);
                        if (monthlyLineChart.value) monthlyLineInstance = echarts.init(monthlyLineChart.value);
                        if (hotBooksChart.value) hotBooksInstance = echarts.init(hotBooksChart.value);
                        if (activeUsersChart.value) activeUsersInstance = echarts.init(activeUsersChart.value);

                        // 窗口大小变化时自适应
                        window.addEventListener('resize', () => {
                            categoryPieInstance?.resize();
                            rolePieInstance?.resize();
                            monthlyLineInstance?.resize();
                            hotBooksInstance?.resize();
                            activeUsersInstance?.resize();
                        });
                    } catch (e) {
                        console.error('Chart init failed:', e);
                    }
                };

                // 更新分类饼图
                const updateCategoryPieChart = () => {
                    if (!categoryPieInstance || stats.categoryStats.length === 0) return;
                    const option = {
                        tooltip: { trigger: 'item', formatter: '{b}: {c}次 ({d}%)' },
                        legend: { orient: 'vertical', right: 10, top: 'center', textStyle: { fontSize: 12 } },
                        color: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#14b8a6'],
                        series: [{
                            name: '借阅分类',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['40%', '50%'],
                            avoidLabelOverlap: true,
                            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                            label: { show: false },
                            emphasis: {
                                label: { show: true, fontSize: 14, fontWeight: 'bold' },
                                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.3)' }
                            },
                            data: stats.categoryStats.map(item => ({ value: item.borrowCount, name: item.categoryName }))
                        }]
                    };
                    categoryPieInstance.setOption(option, true);
                };

                // 更新角色饼图
                const updateRolePieChart = () => {
                    if (!rolePieInstance || stats.userRoleStats.length === 0) return;
                    const option = {
                        tooltip: { trigger: 'item', formatter: '{b}: {c}次 ({d}%)' },
                        legend: { orient: 'vertical', right: 10, top: 'center', textStyle: { fontSize: 12 } },
                        color: ['#10b981', '#6366f1', '#f59e0b'],
                        series: [{
                            name: '角色分布',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['40%', '50%'],
                            avoidLabelOverlap: true,
                            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                            label: { show: false },
                            emphasis: {
                                label: { show: true, fontSize: 14, fontWeight: 'bold' },
                                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.3)' }
                            },
                            data: stats.userRoleStats.map(item => ({ value: item.borrowCount, name: item.roleName }))
                        }]
                    };
                    rolePieInstance.setOption(option, true);
                };

                // 更新月度趋势折线图
                const updateMonthlyLineChart = () => {
                    if (!monthlyLineInstance) return;
                    // 即使没有数据也显示空图表
                    const months = stats.monthlyStats.map(item => item.month);
                    const borrowCounts = stats.monthlyStats.map(item => item.borrowCount);
                    const returnCounts = stats.monthlyStats.map(item => item.returnCount);

                    const option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                        legend: { data: ['借阅数量', '归还数量'], top: 0 },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: months,
                            axisLine: { lineStyle: { color: '#e5e7eb' } },
                            axisLabel: { color: '#6b7280' }
                        },
                        yAxis: {
                            type: 'value',
                            minInterval: 1,
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { lineStyle: { color: '#f3f4f6' } },
                            axisLabel: { color: '#6b7280' }
                        },
                        series: [
                            {
                                name: '借阅数量',
                                type: 'line',
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 8,
                                lineStyle: { width: 3, color: '#6366f1' },
                                itemStyle: { color: '#6366f1' },
                                areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(99, 102, 241, 0.3)' }, { offset: 1, color: 'rgba(99, 102, 241, 0.05)' }] } },
                                data: borrowCounts
                            },
                            {
                                name: '归还数量',
                                type: 'line',
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 8,
                                lineStyle: { width: 3, color: '#10b981' },
                                itemStyle: { color: '#10b981' },
                                areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(16, 185, 129, 0.3)' }, { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }] } },
                                data: returnCounts
                            }
                        ]
                    };
                    monthlyLineInstance.setOption(option, true);
                    monthlyLineInstance.resize();
                };

                // 更新热门图书柱状图
                const updateHotBooksChart = () => {
                    if (!hotBooksInstance) return;
                    const books = stats.hotBooks.slice(0, 10).reverse();
                    const option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '8%', bottom: '3%', top: '3%', containLabel: true },
                        xAxis: { type: 'value', minInterval: 1, axisLine: { show: false }, axisTick: { show: false }, splitLine: { lineStyle: { color: '#f3f4f6' } }, axisLabel: { color: '#6b7280' } },
                        yAxis: { type: 'category', data: books.map(b => b.title?.length > 12 ? b.title.substring(0, 12) + '...' : b.title), axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: '#374151', fontSize: 12 } },
                        series: [{
                            type: 'bar',
                            data: books.map((b, i) => ({
                                value: b.borrowCount,
                                itemStyle: {
                                    color: { type: 'linear', x: 0, y: 0, x2: 1, y2: 0, colorStops: [{ offset: 0, color: '#6366f1' }, { offset: 1, color: '#8b5cf6' }] },
                                    borderRadius: [0, 4, 4, 0]
                                }
                            })),
                            barMaxWidth: 30, // 限制最大宽度
                            label: { show: true, position: 'right', color: '#6366f1', fontWeight: 'bold' }
                        }]
                    };
                    hotBooksInstance.setOption(option, true);
                    hotBooksInstance.resize();
                };

                // 更新活跃用户柱状图
                const updateActiveUsersChart = () => {
                    if (!activeUsersInstance) return;
                    const users = stats.activeUsers.slice(0, 10).reverse();
                    const option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '8%', bottom: '3%', top: '3%', containLabel: true },
                        xAxis: { type: 'value', minInterval: 1, axisLine: { show: false }, axisTick: { show: false }, splitLine: { lineStyle: { color: '#f3f4f6' } }, axisLabel: { color: '#6b7280' } },
                        yAxis: { type: 'category', data: users.map(u => u.username), axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: '#374151', fontSize: 12 } },
                        series: [{
                            type: 'bar',
                            data: users.map((u, i) => ({
                                value: u.borrowCount,
                                itemStyle: {
                                    color: { type: 'linear', x: 0, y: 0, x2: 1, y2: 0, colorStops: [{ offset: 0, color: '#10b981' }, { offset: 1, color: '#34d399' }] },
                                    borderRadius: [0, 4, 4, 0]
                                }
                            })),
                            barMaxWidth: 30, // 限制最大宽度
                            label: { show: true, position: 'right', color: '#10b981', fontWeight: 'bold' }
                        }]
                    };
                    activeUsersInstance.setOption(option, true);
                    activeUsersInstance.resize();
                };

                // 更新所有图表
                const updateAllCharts = () => {
                    Vue.nextTick(() => {
                        updateCategoryPieChart();
                        updateRolePieChart();
                        updateMonthlyLineChart();
                        updateHotBooksChart();
                        updateActiveUsersChart();
                    });
                };

                const loadStatistics = async () => {
                    try {
                        const params = {};
                        if (dateRange.value && dateRange.value.length === 2) {
                            params.startDate = dateRange.value[0];
                            params.endDate = dateRange.value[1];
                        }

                        const result = await api.getAdvancedStatistics(params);
                        stats.totalBorrows = result.totalBorrows || 0;
                        stats.totalReturns = result.totalReturns || 0;
                        stats.overdueCount = result.overdueCount || 0;
                        stats.totalFines = result.totalFines ? parseFloat(result.totalFines).toFixed(2) : '0.00';
                        stats.categoryStats = result.categoryStats || [];
                        stats.monthlyStats = result.monthlyStats || [];
                        stats.userRoleStats = result.userRoleStats || [];
                        stats.hotBooks = result.hotBooks || [];
                        stats.activeUsers = result.activeUsers || [];

                        updateAllCharts();
                    } catch (e) {
                        // ElMessage.error('加载统计数据失败: ' + e.message); // 暂时注释掉错误提示,避免页面加载时报错干扰
                        console.error(e);
                    }
                };

                const resetFilters = () => {
                    dateRange.value = null;
                    loadStatistics();
                };

                onMounted(() => {
                    // 延迟初始化,确保DOM渲染完成,解决布局错乱问题
                    setTimeout(() => {
                        initCharts();
                        loadStatistics();
                    }, 300);
                });

                return { dateRange, stats, loadStatistics, resetFilters, categoryPieChart, rolePieChart, monthlyLineChart, hotBooksChart, activeUsersChart };
            }
        };

        // 罚款管理组件
        const FineManager = {
            template: `
                <div class="p-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">罚款管理</h1>

                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
                            <div class="text-2xl font-bold text-red-600">{{ statistics.totalUnpaidAmount || 0 }}元</div>
                            <div class="text-gray-500 text-sm">待缴纳总额</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-orange-500">
                            <div class="text-2xl font-bold text-orange-600">{{ statistics.statusCounts?.UNPAID || 0 }}</div>
                            <div class="text-gray-500 text-sm">未缴纳记录</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
                            <div class="text-2xl font-bold text-green-600">{{ statistics.statusCounts?.PAID || 0 }}</div>
                            <div class="text-gray-500 text-sm">已缴纳记录</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
                            <div class="text-2xl font-bold text-blue-600">{{ statistics.statusCounts?.WAIVED || 0 }}</div>
                            <div class="text-gray-500 text-sm">已免除记录</div>
                        </div>
                    </div>

                    <!-- 罚款规则配置 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">罚款规则配置</h2>
                            <el-button type="primary" size="small" @click="openRuleDialog" v-if="isAdmin">
                                <el-icon class="mr-1"><Edit /></el-icon>修改规则
                            </el-button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-gray-500 text-sm mb-1">每日罚金</div>
                                <div class="text-xl font-bold text-indigo-600">{{ currentRule.dailyAmount || 0.5 }}元/天</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-gray-500 text-sm mb-1">封顶金额</div>
                                <div class="text-xl font-bold text-indigo-600">{{ currentRule.maxAmount == 0 ? '无封顶' : currentRule.maxAmount + '元' }}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-gray-500 text-sm mb-1">免罚天数</div>
                                <div class="text-xl font-bold text-indigo-600">{{ currentRule.graceDays || 0 }}天</div>
                            </div>
                        </div>
                        <div v-if="currentRule.description" class="mt-4 text-gray-500 text-sm">
                            <el-icon><InfoFilled /></el-icon> {{ currentRule.description }}
                        </div>
                    </div>

                    <!-- 筛选条件 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
                        <div class="flex gap-4 flex-wrap">
                            <el-select v-model="filters.status" placeholder="状态" clearable style="width: 120px" @change="loadFineRecords">
                                <el-option label="未缴纳" value="UNPAID" />
                                <el-option label="已缴纳" value="PAID" />
                                <el-option label="已免除" value="WAIVED" />
                            </el-select>
                            <el-input v-model="filters.username" placeholder="搜索用户名" clearable style="width: 160px" @keyup.enter="loadFineRecords" />
                            <el-button @click="loadFineRecords">搜索</el-button>
                            <el-button @click="resetFilters">重置</el-button>
                        </div>
                    </div>

                    <!-- 罚款记录列表 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="fineRecords" class="custom-table" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="70" />
                            <el-table-column label="用户" width="140">
                                <template #default="{row}">
                                    <div>{{ row.username }}</div>
                                    <div class="text-gray-400 text-xs">{{ row.realName }}</div>
                                </template>
                            </el-table-column>
                            <el-table-column label="图书" min-width="180">
                                <template #default="{row}">
                                    <el-link type="primary" :underline="false">{{ row.bookTitle }}</el-link>
                                </template>
                            </el-table-column>
                            <el-table-column label="逾期天数" width="100">
                                <template #default="{row}">
                                    <span class="text-orange-500 font-medium">{{ row.overdueDays }}天</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="罚款金额" width="110">
                                <template #default="{row}">
                                    <span class="text-red-500 font-bold">{{ row.amount }}元</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="状态" width="100">
                                <template #default="{row}">
                                    <el-tag :type="getStatusType(row.status)" size="small">{{ row.statusText }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="缴费/免除时间" width="160">
                                <template #default="{row}">
                                    <span v-if="row.paidAt">{{ formatDateTime(row.paidAt) }}</span>
                                    <span v-else-if="row.waivedAt">{{ formatDateTime(row.waivedAt) }}</span>
                                    <span v-else class="text-gray-400">-</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="createdAt" label="产生时间" width="160">
                                <template #default="{row}">{{ formatDateTime(row.createdAt) }}</template>
                            </el-table-column>
                            <el-table-column label="操作" width="160" fixed="right">
                                <template #default="{row}">
                                    <template v-if="row.status === 'UNPAID'">
                                        <el-button size="small" type="success" link @click="handlePay(row)">确认缴费</el-button>
                                        <el-button v-if="isAdmin" size="small" type="warning" link @click="openWaiveDialog(row)">免除</el-button>
                                    </template>
                                    <template v-else-if="row.status === 'WAIVED'">
                                        <el-tooltip :content="'免除原因: ' + row.waiveReason" placement="top">
                                            <el-button size="small" type="info" link>查看原因</el-button>
                                        </el-tooltip>
                                    </template>
                                    <span v-else class="text-gray-400 text-sm">-</span>
                                </template>
                            </el-table-column>
                        </el-table>
                        <div class="flex justify-end p-4 border-t">
                            <el-pagination
                                v-model:current-page="page"
                                v-model:page-size="pageSize"
                                :total="total"
                                :page-sizes="[10, 20, 50]"
                                layout="total, sizes, prev, pager, next"
                                @size-change="loadFineRecords"
                                @current-change="loadFineRecords"
                            />
                        </div>
                    </div>

                    <!-- 修改规则弹窗 -->
                    <el-dialog v-model="ruleDialogVisible" title="修改罚款规则" width="500px" destroy-on-close>
                        <el-form :model="ruleForm" label-width="100px" ref="ruleFormRef">
                            <el-form-item label="每日罚金" prop="dailyAmount">
                                <el-input-number v-model="ruleForm.dailyAmount" :min="0.01" :max="10" :precision="2" :step="0.1" />
                                <span class="ml-2 text-gray-500">元/天</span>
                            </el-form-item>
                            <el-form-item label="封顶金额" prop="maxAmount">
                                <el-input-number v-model="ruleForm.maxAmount" :min="0" :max="1000" :precision="2" :step="10" />
                                <span class="ml-2 text-gray-500">元（0表示不封顶）</span>
                            </el-form-item>
                            <el-form-item label="免罚天数" prop="graceDays">
                                <el-input-number v-model="ruleForm.graceDays" :min="0" :max="30" :step="1" />
                                <span class="ml-2 text-gray-500">天</span>
                            </el-form-item>
                            <el-form-item label="规则描述" prop="description">
                                <el-input v-model="ruleForm.description" type="textarea" :rows="2" placeholder="可选，描述此规则" />
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="ruleDialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="saveRules" :loading="savingRule">保存</el-button>
                        </template>
                    </el-dialog>

                    <!-- 免除罚款弹窗 -->
                    <el-dialog v-model="waiveDialogVisible" title="免除罚款" width="450px" destroy-on-close>
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-500">用户：<span class="text-gray-800">{{ currentFine?.username }}</span></div>
                            <div class="text-sm text-gray-500">图书：<span class="text-gray-800">{{ currentFine?.bookTitle }}</span></div>
                            <div class="text-sm text-gray-500">罚款金额：<span class="text-red-500 font-bold">{{ currentFine?.amount }}元</span></div>
                        </div>
                        <el-form :model="waiveForm" ref="waiveFormRef">
                            <el-form-item label="免除原因" prop="reason" :rules="[{ required: true, message: '请输入免除原因', trigger: 'blur' }]">
                                <el-input v-model="waiveForm.reason" type="textarea" :rows="3" placeholder="请输入免除原因" />
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="waiveDialogVisible = false">取消</el-button>
                            <el-button type="warning" @click="confirmWaive" :loading="waiving">确认免除</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const store = useAdminStore();
                const isAdmin = computed(() => store.userInfo.rawRole === 'ADMIN');

                const loading = ref(false);
                const fineRecords = ref([]);
                const page = ref(1);
                const pageSize = ref(10);
                const total = ref(0);

                const statistics = ref({});
                const currentRule = ref({});

                const filters = reactive({
                    status: '',
                    username: ''
                });

                // 规则弹窗
                const ruleDialogVisible = ref(false);
                const ruleFormRef = ref(null);
                const savingRule = ref(false);
                const ruleForm = reactive({
                    dailyAmount: 0.5,
                    maxAmount: 100,
                    graceDays: 0,
                    description: ''
                });

                // 免除弹窗
                const waiveDialogVisible = ref(false);
                const waiveFormRef = ref(null);
                const waiving = ref(false);
                const currentFine = ref(null);
                const waiveForm = reactive({
                    reason: ''
                });

                const getStatusType = (status) => {
                    const map = { 'UNPAID': 'danger', 'PAID': 'success', 'WAIVED': 'warning' };
                    return map[status] || 'info';
                };

                const formatDateTime = (str) => {
                    if (!str) return '';
                    return str.replace('T', ' ').substring(0, 19);
                };

                const loadFineRecords = async () => {
                    loading.value = true;
                    try {
                        const params = {
                            page: page.value,
                            size: pageSize.value,
                            ...(filters.status && { status: filters.status }),
                            ...(filters.username && { username: filters.username })
                        };
                        const result = await api.getFineRecords(params);
                        fineRecords.value = result.list || [];
                        total.value = result.total || 0;
                    } catch (error) {
                        ElMessage.error(error.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadStatistics = async () => {
                    try {
                        statistics.value = await api.getFineStatistics();
                        if (statistics.value.currentRule) {
                            currentRule.value = statistics.value.currentRule;
                        }
                    } catch (error) {
                        console.error('加载统计失败:', error);
                    }
                };

                const loadCurrentRule = async () => {
                    try {
                        currentRule.value = await api.getFineRules();
                    } catch (error) {
                        console.error('加载规则失败:', error);
                    }
                };

                const resetFilters = () => {
                    filters.status = '';
                    filters.username = '';
                    page.value = 1;
                    loadFineRecords();
                };

                const openRuleDialog = () => {
                    ruleForm.dailyAmount = currentRule.value.dailyAmount || 0.5;
                    ruleForm.maxAmount = currentRule.value.maxAmount || 100;
                    ruleForm.graceDays = currentRule.value.graceDays || 0;
                    ruleForm.description = currentRule.value.description || '';
                    ruleDialogVisible.value = true;
                };

                const saveRules = async () => {
                    savingRule.value = true;
                    try {
                        await api.updateFineRules(ruleForm);
                        ElMessage.success('规则更新成功');
                        ruleDialogVisible.value = false;
                        loadCurrentRule();
                        loadStatistics();
                    } catch (error) {
                        ElMessage.error(error.message);
                    } finally {
                        savingRule.value = false;
                    }
                };

                const handlePay = async (row) => {
                    try {
                        await ElMessageBox.confirm(
                            `确认用户 "${row.username}" 已缴纳罚款 ${row.amount} 元？`,
                            '确认缴费',
                            { type: 'success' }
                        );
                        await api.payFine(row.id);
                        ElMessage.success('缴费确认成功');
                        loadFineRecords();
                        loadStatistics();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error(error.message || '操作失败');
                        }
                    }
                };

                const openWaiveDialog = (row) => {
                    currentFine.value = row;
                    waiveForm.reason = '';
                    waiveDialogVisible.value = true;
                };

                const confirmWaive = async () => {
                    if (!waiveForm.reason.trim()) {
                        ElMessage.warning('请输入免除原因');
                        return;
                    }
                    waiving.value = true;
                    try {
                        await api.waiveFine(currentFine.value.id, waiveForm.reason);
                        ElMessage.success('罚款已免除');
                        waiveDialogVisible.value = false;
                        loadFineRecords();
                        loadStatistics();
                    } catch (error) {
                        ElMessage.error(error.message);
                    } finally {
                        waiving.value = false;
                    }
                };

                onMounted(() => {
                    loadFineRecords();
                    loadStatistics();
                });

                return {
                    store, isAdmin, loading, fineRecords, page, pageSize, total,
                    statistics, currentRule, filters,
                    ruleDialogVisible, ruleFormRef, savingRule, ruleForm,
                    waiveDialogVisible, waiveFormRef, waiving, currentFine, waiveForm,
                    getStatusType, formatDateTime, loadFineRecords, resetFilters,
                    openRuleDialog, saveRules, handlePay, openWaiveDialog, confirmWaive
                };
            }
        };

        // 9. 公告管理组件
        const AnnouncementManager = {
            template: `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">公告管理</h1>
                        <el-button type="primary" @click="openAddDialog">
                            <el-icon class="mr-1"><Plus /></el-icon>发布公告
                        </el-button>
                    </div>

                    <!-- 筛选条件 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6">
                        <div class="flex gap-4 flex-wrap">
                            <el-select v-model="filters.status" placeholder="状态" clearable style="width: 120px" @change="loadAnnouncements">
                                <el-option label="草稿" :value="0" />
                                <el-option label="已发布" :value="1" />
                            </el-select>
                            <el-select v-model="filters.type" placeholder="类型" clearable style="width: 120px" @change="loadAnnouncements">
                                <el-option label="普通" value="NORMAL" />
                                <el-option label="重要" value="IMPORTANT" />
                                <el-option label="活动" value="ACTIVITY" />
                                <el-option label="维护" value="MAINTENANCE" />
                            </el-select>
                            <el-input v-model="filters.keyword" placeholder="搜索标题或内容" clearable style="width: 200px" @keyup.enter="loadAnnouncements" />
                            <el-button @click="loadAnnouncements">搜索</el-button>
                            <el-button @click="resetFilters">重置</el-button>
                        </div>
                    </div>

                    <!-- 公告列表 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <el-table :data="announcements" class="custom-table" v-loading="loading">
                            <el-table-column prop="id" label="ID" width="70" />
                            <el-table-column label="标题" min-width="200">
                                <template #default="{row}">
                                    <div class="flex items-center gap-2">
                                        <el-tag v-if="row.pinned" type="danger" size="small">置顶</el-tag>
                                        <span>{{ row.title }}</span>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="类型" width="100">
                                <template #default="{row}">
                                    <el-tag :type="getTypeTag(row.type)" size="small">{{ row.typeDesc }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="状态" width="90">
                                <template #default="{row}">
                                    <el-tag :type="row.status === 1 ? 'success' : 'info'" size="small">
                                        {{ row.status === 1 ? '已发布' : '草稿' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="publisherName" label="发布者" width="100" />
                            <el-table-column prop="createdAt" label="创建时间" width="160">
                                <template #default="{row}">{{ formatDateTime(row.createdAt) }}</template>
                            </el-table-column>
                            <el-table-column label="操作" width="280" fixed="right">
                                <template #default="{row}">
                                    <el-button size="small" type="primary" link @click="viewDetail(row)">查看</el-button>
                                    <el-button size="small" type="primary" link @click="editAnnouncement(row)">编辑</el-button>
                                    <el-button v-if="row.status === 0" size="small" type="success" link @click="publish(row)">发布</el-button>
                                    <el-button v-if="row.status === 1" size="small" type="warning" link @click="unpublish(row)">撤回</el-button>
                                    <el-button size="small" :type="row.pinned ? 'info' : 'danger'" link @click="togglePin(row)">
                                        {{ row.pinned ? '取消置顶' : '置顶' }}
                                    </el-button>
                                    <el-button size="small" type="danger" link @click="deleteAnnouncement(row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <div class="flex justify-end p-4 border-t">
                            <el-pagination
                                v-model:current-page="page"
                                v-model:page-size="pageSize"
                                :total="total"
                                :page-sizes="[10, 20, 50]"
                                layout="total, sizes, prev, pager, next"
                                @size-change="loadAnnouncements"
                                @current-change="loadAnnouncements"
                            />
                        </div>
                    </div>

                    <!-- 编辑/新增弹窗 -->
                    <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑公告' : '发布公告'" width="700px" destroy-on-close>
                        <el-form :model="form" label-width="80px" ref="formRef" :rules="rules">
                            <el-form-item label="标题" prop="title">
                                <el-input v-model="form.title" placeholder="请输入公告标题" maxlength="200" show-word-limit />
                            </el-form-item>
                            <el-form-item label="类型" prop="type">
                                <el-select v-model="form.type" placeholder="选择公告类型" style="width: 100%">
                                    <el-option label="普通公告" value="NORMAL" />
                                    <el-option label="重要通知" value="IMPORTANT" />
                                    <el-option label="活动公告" value="ACTIVITY" />
                                    <el-option label="维护公告" value="MAINTENANCE" />
                                </el-select>
                            </el-form-item>
                            <el-form-item label="内容" prop="content">
                                <el-input v-model="form.content" type="textarea" :rows="8" placeholder="请输入公告内容" maxlength="5000" show-word-limit />
                            </el-form-item>
                            <el-form-item label="置顶">
                                <el-switch v-model="form.pinned" />
                            </el-form-item>
                            <el-form-item label="立即发布">
                                <el-switch v-model="form.publishNow" />
                                <span class="text-gray-400 text-sm ml-2">{{ form.publishNow ? '保存后立即发布' : '保存为草稿' }}</span>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="dialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="saveAnnouncement" :loading="saving">保存</el-button>
                        </template>
                    </el-dialog>

                    <!-- 详情弹窗 -->
                    <el-dialog v-model="detailVisible" title="公告详情" width="600px">
                        <div v-if="currentDetail" class="space-y-4">
                            <div class="flex items-center gap-2">
                                <el-tag v-if="currentDetail.pinned" type="danger" size="small">置顶</el-tag>
                                <el-tag :type="getTypeTag(currentDetail.type)" size="small">{{ currentDetail.typeDesc }}</el-tag>
                                <el-tag :type="currentDetail.status === 1 ? 'success' : 'info'" size="small">
                                    {{ currentDetail.status === 1 ? '已发布' : '草稿' }}
                                </el-tag>
                            </div>
                            <h3 class="text-xl font-bold">{{ currentDetail.title }}</h3>
                            <div class="text-gray-500 text-sm">
                                发布者：{{ currentDetail.publisherName }} | 创建时间：{{ formatDateTime(currentDetail.createdAt) }}
                            </div>
                            <el-divider />
                            <div class="text-gray-700 whitespace-pre-wrap leading-relaxed">{{ currentDetail.content }}</div>
                        </div>
                    </el-dialog>
                </div>
            `,
            setup() {
                const formRef = ref(null);
                const loading = ref(false);
                const saving = ref(false);
                const announcements = ref([]);
                const page = ref(1);
                const pageSize = ref(10);
                const total = ref(0);

                const filters = reactive({
                    status: null,
                    type: '',
                    keyword: ''
                });

                const dialogVisible = ref(false);
                const detailVisible = ref(false);
                const isEdit = ref(false);
                const currentDetail = ref(null);

                const form = reactive({
                    id: null,
                    title: '',
                    content: '',
                    type: 'NORMAL',
                    pinned: false,
                    publishNow: false
                });

                const rules = {
                    title: [{ required: true, message: '请输入公告标题', trigger: 'blur' }],
                    content: [{ required: true, message: '请输入公告内容', trigger: 'blur' }]
                };

                const getTypeTag = (type) => {
                    const map = { NORMAL: 'info', IMPORTANT: 'danger', ACTIVITY: 'success', MAINTENANCE: 'warning' };
                    return map[type] || 'info';
                };

                const formatDateTime = (str) => {
                    if (!str) return '-';
                    return str.replace('T', ' ').substring(0, 16);
                };

                const loadAnnouncements = async () => {
                    loading.value = true;
                    try {
                        const params = { page: page.value, size: pageSize.value };
                        if (filters.status !== null) params.status = filters.status;
                        if (filters.type) params.type = filters.type;
                        if (filters.keyword) params.keyword = filters.keyword;

                        const result = await api.getAnnouncements(params);
                        announcements.value = result.list || [];
                        total.value = result.total || 0;
                    } catch (e) {
                        ElMessage.error('加载公告失败: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const resetFilters = () => {
                    filters.status = null;
                    filters.type = '';
                    filters.keyword = '';
                    page.value = 1;
                    loadAnnouncements();
                };

                const openAddDialog = () => {
                    isEdit.value = false;
                    Object.assign(form, { id: null, title: '', content: '', type: 'NORMAL', pinned: false, publishNow: false });
                    dialogVisible.value = true;
                };

                const editAnnouncement = (row) => {
                    isEdit.value = true;
                    Object.assign(form, {
                        id: row.id,
                        title: row.title,
                        content: row.content,
                        type: row.type,
                        pinned: row.pinned,
                        publishNow: row.status === 1
                    });
                    dialogVisible.value = true;
                };

                const saveAnnouncement = async () => {
                    if (!formRef.value) return;
                    await formRef.value.validate();

                    saving.value = true;
                    try {
                        const data = {
                            title: form.title,
                            content: form.content,
                            type: form.type,
                            pinned: form.pinned,
                            status: form.publishNow ? 1 : 0
                        };

                        if (isEdit.value && form.id) {
                            await api.updateAnnouncement(form.id, data);
                            ElMessage.success('更新成功');
                        } else {
                            await api.createAnnouncement(data);
                            ElMessage.success('创建成功');
                        }
                        dialogVisible.value = false;
                        loadAnnouncements();
                    } catch (e) {
                        ElMessage.error(e.message || '操作失败');
                    } finally {
                        saving.value = false;
                    }
                };

                const viewDetail = (row) => {
                    currentDetail.value = row;
                    detailVisible.value = true;
                };

                const publish = async (row) => {
                    try {
                        await api.publishAnnouncement(row.id);
                        ElMessage.success('发布成功');
                        loadAnnouncements();
                    } catch (e) {
                        ElMessage.error(e.message || '发布失败');
                    }
                };

                const unpublish = async (row) => {
                    try {
                        await api.unpublishAnnouncement(row.id);
                        ElMessage.success('已撤回');
                        loadAnnouncements();
                    } catch (e) {
                        ElMessage.error(e.message || '撤回失败');
                    }
                };

                const togglePin = async (row) => {
                    try {
                        await api.toggleAnnouncementPin(row.id);
                        ElMessage.success(row.pinned ? '已取消置顶' : '已置顶');
                        loadAnnouncements();
                    } catch (e) {
                        ElMessage.error(e.message || '操作失败');
                    }
                };

                const deleteAnnouncement = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定要删除这条公告吗？', '删除确认', { type: 'warning' });
                        await api.deleteAnnouncement(row.id);
                        ElMessage.success('删除成功');
                        loadAnnouncements();
                    } catch (e) {
                        if (e !== 'cancel') ElMessage.error(e.message || '删除失败');
                    }
                };

                onMounted(loadAnnouncements);

                return {
                    formRef, loading, saving, announcements, page, pageSize, total, filters,
                    dialogVisible, detailVisible, isEdit, currentDetail, form, rules,
                    getTypeTag, formatDateTime, loadAnnouncements, resetFilters,
                    openAddDialog, editAnnouncement, saveAnnouncement, viewDetail,
                    publish, unpublish, togglePin, deleteAnnouncement
                };
            }
        };

        // 10. 布局组件 (Header Updated with Notification Details & Settings Sync)
        const Layout = {
            template: `
                <div class="flex h-screen overflow-hidden">
                    <!-- Sidebar -->
                    <div class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col transition-all duration-300">
                        <div class="h-16 flex items-center px-6 border-b border-slate-800">
                            <div class="w-8 h-8 bg-indigo-500 rounded flex items-center justify-center mr-3 font-bold">A</div>
                            <span class="font-bold text-lg tracking-wide">Admin Pro</span>
                        </div>
                        <el-menu router :default-active="$route.path" class="sidebar-menu flex-1 py-4">
                            <el-menu-item index="/dashboard"><el-icon><Odometer /></el-icon><span>控制台</span></el-menu-item>

                            <div class="px-6 text-xs font-bold text-slate-500 mt-4 mb-2 uppercase">业务管理</div>
                            <el-menu-item index="/books"><el-icon><Collection /></el-icon><span>图书管理</span></el-menu-item>
                            <el-menu-item index="/borrows"><el-icon><Tickets /></el-icon><span>借阅记录</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员', '馆员'])" index="/announcements"><el-icon><Bell /></el-icon><span>公告管理</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员', '馆员'])" index="/fines"><el-icon><Money /></el-icon><span>罚款管理</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员', '馆员'])" index="/statistics"><el-icon><DataAnalysis /></el-icon><span>统计报表</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员', '普通管理员'])" index="/reviews"><el-icon><ChatLineSquare /></el-icon><span>评论管理</span></el-menu-item>

                            <div v-if="store.hasPermission(['超级管理员'])" class="px-6 text-xs font-bold text-slate-500 mt-4 mb-2 uppercase">系统设置</div>
                            <el-menu-item v-if="store.hasPermission(['超级管理员'])" index="/admins"><el-icon><UserFilled /></el-icon><span>人员管理</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员'])" index="/user-approval"><el-icon><User /></el-icon><span>用户审核</span></el-menu-item>
                            <el-menu-item v-if="store.hasPermission(['超级管理员'])" index="/logs"><el-icon><Document /></el-icon><span>操作日志</span></el-menu-item>
                        </el-menu>
                        <div class="p-4 border-t border-slate-800">
                            <div class="flex items-center gap-3">
                                <el-avatar :size="32" :src="store.userInfo.avatar" class="bg-indigo-600">A</el-avatar>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium truncate">{{ store.userInfo.username }}</div>
                                    <div class="text-xs text-slate-400">{{ store.userInfo.role }}</div>
                                </div>
                                <button class="text-slate-400 hover:text-white" @click="logout"><el-icon><SwitchButton /></el-icon></button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col min-w-0 bg-gray-50">
                        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm z-10">
                            <div class="text-gray-500 text-sm">欢迎回来，今天是 {{ new Date().toLocaleDateString() }}</div>
                            <div class="flex gap-4">
                                <!-- Notifications -->
                                <el-popover placement="bottom" :width="320" trigger="click">
                                    <template #reference>
                                        <el-button circle class="relative">
                                            <el-icon><Bell /></el-icon>
                                            <span v-if="unreadCount > 0" class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
                                        </el-button>
                                    </template>
                                    <div class="p-2">
                                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                                            <h3 class="font-bold text-gray-700">消息通知</h3>
                                            <el-button link type="primary" size="small" @click="markAllRead" :disabled="!unreadCount">一键已读</el-button>
                                        </div>
                                        <div v-if="notifications.length === 0" class="text-center text-gray-400 py-4">暂无新消息</div>
                                        <ul v-else class="space-y-1 max-h-64 overflow-y-auto">
                                            <li v-for="(n, i) in notifications" :key="i" @click="viewNotification(n)" class="notification-item flex items-start gap-3 text-sm">
                                                <div :class="{'bg-blue-500': n.type=='info', 'bg-orange-500': n.type=='warning', 'bg-green-500': n.type=='success', 'opacity-50': n.read}" class="w-2 h-2 mt-1.5 rounded-full flex-shrink-0"></div>
                                                <div class="flex-1" :class="{'opacity-60': n.read}">
                                                    <div class="text-gray-700 font-medium truncate">{{n.title}}</div>
                                                    <div class="text-xs text-gray-400 mt-0.5">{{n.time}}</div>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </el-popover>

                                <!-- Settings -->
                                <el-button circle @click="showSettings = true"><el-icon><Setting /></el-icon></el-button>
                            </div>
                        </header>
                        <main class="flex-1 overflow-auto">
                            <router-view v-slot="{ Component }">
                                <transition name="el-fade-in-linear" mode="out-in">
                                    <component :is="Component" />
                                </transition>
                            </router-view>
                        </main>
                    </div>

                    <!-- Notification Detail Dialog -->
                    <el-dialog v-model="showNotifyDetail" title="消息详情" width="400px" align-center append-to-body>
                        <div v-if="selectedNotify">
                            <div class="flex items-center gap-2 mb-4">
                                <el-tag size="small" :type="selectedNotify.type">{{ selectedNotify.type.toUpperCase() }}</el-tag>
                                <span class="text-gray-400 text-xs">{{ selectedNotify.time }}</span>
                            </div>
                            <h3 class="font-bold text-lg mb-2">{{ selectedNotify.title }}</h3>
                            <p class="text-gray-600 leading-relaxed">{{ selectedNotify.content }}</p>
                        </div>
                        <template #footer>
                            <el-button type="primary" @click="showNotifyDetail = false">关闭</el-button>
                        </template>
                    </el-dialog>

                    <!-- Settings Dialog -->
                    <el-dialog v-model="showSettings" title="系统设置" width="500px" align-center append-to-body>
                        <el-form label-position="top">
                            <el-form-item label="系统名称">
                                <el-input v-model="sysConfig.sysName" />
                            </el-form-item>
                            <el-form-item label="全站公告">
                                <el-input v-model="sysConfig.announcement" type="textarea" rows="2" placeholder="请输入滚动公告内容..." />
                            </el-form-item>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span>开放用户注册</span>
                                <el-switch v-model="sysConfig.allowRegister" />
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span>系统维护模式</span>
                                <el-switch v-model="sysConfig.maintenance" active-text="开启" inactive-text="关闭" />
                            </div>
                        </el-form>
                        <template #footer>
                            <el-button @click="showSettings = false">取消</el-button>
                            <el-button type="primary" @click="handleSaveSettings">保存配置</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const store = useAdminStore();
                // 通知数据从后端获取
                const notifications = ref([]);
                const unreadCount = ref(0);

                const showSettings = ref(false);
                const showNotifyDetail = ref(false);
                const selectedNotify = ref(null);

                const sysConfig = reactive({
                    sysName: '智慧图书 - 云端书城',
                    announcement: '',
                    allowRegister: true,
                    maintenance: false
                });

                // 加载通知
                const loadNotifications = async () => {
                    try {
                        const result = await api.getNotifications({ page: 0, size: 10 });
                        notifications.value = result.list;
                    } catch (e) {
                        console.error('加载通知失败:', e);
                    }
                };

                // 加载未读数量
                const loadUnreadCount = async () => {
                    try {
                        unreadCount.value = await api.getUnreadCount();
                    } catch (e) {
                        console.error('获取未读数量失败:', e);
                    }
                };

                // Load initial config and notifications
                onMounted(async () => {
                    const config = await api.getConfig();
                    if (config) Object.assign(sysConfig, config);
                    await loadNotifications();
                    await loadUnreadCount();
                    // 每分钟刷新未读数量
                    setInterval(loadUnreadCount, 60000);
                });

                const viewNotification = async (n) => {
                    selectedNotify.value = n;
                    showNotifyDetail.value = true;
                    if (!n.read) {
                        try {
                            await api.markNotificationRead(n.id);
                            n.read = true;
                            unreadCount.value = Math.max(0, unreadCount.value - 1);
                        } catch (e) {
                            console.error('标记已读失败:', e);
                        }
                    }
                };

                const markAllRead = async () => {
                    try {
                        await api.markAllNotificationsRead();
                        notifications.value.forEach(n => n.read = true);
                        unreadCount.value = 0;
                        ElMessage.success('全部已读');
                    } catch (e) {
                        ElMessage.error('操作失败: ' + e.message);
                    }
                };

                const handleSaveSettings = async () => {
                    await api.saveConfig({ ...sysConfig });
                    ElMessage.success('系统配置已更新并同步');
                    showSettings.value = false;
                };

                return {
                    store, logout: store.logout,
                    notifications, unreadCount, viewNotification, markAllRead, showNotifyDetail, selectedNotify,
                    showSettings, sysConfig, handleSaveSettings
                };
            }
        };

        // --- 路由配置 ---
        const routes = [
            { path: '/login', component: Login },
            {
                path: '/',
                component: Layout,
                redirect: '/dashboard',
                children: [
                    { path: 'dashboard', component: Dashboard },
                    { path: 'books', component: BookManager },
                    { path: 'borrows', component: BorrowManager },
                    {
                        path: 'announcements',
                        component: AnnouncementManager,
                        meta: { roles: ['超级管理员', '馆员'] }
                    },
                    {
                        path: 'statistics',
                        component: StatisticsManager,
                        meta: { roles: ['超级管理员', '馆员'] }
                    },
                    {
                        path: 'fines',
                        component: FineManager,
                        meta: { roles: ['超级管理员', '馆员'] }
                    },
                    {
                        path: 'reviews',
                        component: ReviewManager,
                        meta: { roles: ['超级管理员', '普通管理员'] }
                    },
                    {
                        path: 'admins',
                        component: AdminManager,
                        meta: { roles: ['超级管理员'] }
                    },
                    {
                        path: 'user-approval',
                        component: UserApprovalManager,
                        meta: { roles: ['超级管理员'] }
                    },
                    {
                        path: 'logs',
                        component: LogManager,
                        meta: { roles: ['超级管理员'] }
                    }
                ]
            }
        ];

        const router = createRouter({ history: createWebHashHistory(), routes });

        // 路由守卫
        router.beforeEach((to, from, next) => {
            const store = useAdminStore();
            if (to.path === '/login') return next();
            if (!store.token) return next('/login');

            if (to.meta.roles && !to.meta.roles.includes(store.userInfo.role)) {
                ElMessage.error('权限不足，无法访问');
                return next('/dashboard');
            }
            next();
        });

        const app = createApp({ template: `<router-view></router-view>` });
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }
        app.use(createPinia());
        app.use(router);
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>