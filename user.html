<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å›¾ä¹¦ - äº‘ç«¯ä¹¦åŸ Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-demi"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <!-- å…¬å…±JSæ¨¡å— -->
    <script src="./js/common.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        /* äº¤é”™å…¥åœºåŠ¨ç”» - FadeInUp */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-item {
            opacity: 0;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* å›¾ä¹¦å¡ç‰‡ - å¢å¼ºæ‚¬åœæ•ˆæœ */
        .book-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .book-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(79, 70, 229, 0.2), 0 12px 24px -8px rgba(0, 0, 0, 0.1);
        }

        .book-card:active {
            transform: translateY(-4px) scale(0.98);
            transition: all 0.1s ease;
        }

        .book-card .cover-img {
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .book-card:hover .cover-img {
            transform: scale(1.08);
        }

        /* è¯„è®ºå¡ç‰‡ - å¢å¼ºæ‚¬åœæ•ˆæœ */
        .review-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.1), 0 8px 16px -8px rgba(0, 0, 0, 0.05);
        }

        /* æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        .btn-press {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-press:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -6px rgba(79, 70, 229, 0.4);
        }

        .btn-press:active {
            transform: scale(0.95) translateY(0);
            box-shadow: 0 2px 8px -2px rgba(79, 70, 229, 0.3);
            transition: all 0.1s ease;
        }

        /* åˆ†ç±»æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        .cat-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cat-btn:active {
            transform: scale(0.92);
            transition: all 0.1s ease;
        }

        /* é€šç”¨å¯ç‚¹å‡»å…ƒç´  */
        .clickable {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .clickable:hover {
            transform: translateY(-2px);
        }

        .clickable:active {
            transform: scale(0.95);
            transition: all 0.1s ease;
        }

        /* å›¾æ ‡æŒ‰é’®æ•ˆæœ */
        .icon-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .icon-btn:active {
            transform: scale(0.9);
            transition: all 0.1s ease;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-dialog .el-dialog {
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .custom-dialog .el-dialog__header {
            display: none;
        }

        .custom-dialog .el-dialog__body {
            padding: 0;
            overflow: hidden;
        }

        .rank-num {
            font-family: 'Impact', sans-serif;
            font-style: italic;
        }

        /* ========== å¼¹çª—ç»„åˆå¼è¿›åœºåŠ¨ç”» ========== */
        /* å·¦ä¾§å°é¢ä»å·¦æ»‘å…¥ */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-60px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* å³ä¾§ä¿¡æ¯ä»å³æ»‘å…¥ */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(60px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ä»ä¸Šæ–¹è½ä¸‹ */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æŸ”å’Œæ·¡å…¥ */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ä»ä¸‹æ–¹å‡èµ· */
        @keyframes fadeInUpModal {
            from {
                opacity: 0;
                transform: translateY(25px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-cover-section {
            opacity: 0;
            animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .modal-info-section {
            opacity: 0;
            animation: slideInRight 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 0.05s;
        }

        .modal-title-area {
            opacity: 0;
            animation: fadeInDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 0.15s;
        }

        .modal-desc-area {
            opacity: 0;
            animation: fadeIn 0.6s ease-out forwards;
            animation-delay: 0.25s;
        }

        .modal-action-area {
            opacity: 0;
            animation: fadeInUpModal 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 0.35s;
        }

        /* å°é¢å›¾ç‰‡å¾®äº¤äº’ - ç”µå½±é•œå¤´æ¨è¿›æ„Ÿ */
        .modal-cover-wrapper {
            overflow: hidden;
        }

        .modal-cover-img {
            transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .modal-cover-wrapper:hover .modal-cover-img {
            transform: scale(1.1);
        }

        /* æ”¶è—æŒ‰é’®è„‰å†²åŠ¨ç”» */
        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .fav-btn-pulse:hover {
            animation: pulse 1s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <div id="app"><router-view></router-view></div>

    <script>
        const { createApp, reactive, ref, computed, onMounted, watch } = Vue;
        const { createRouter, createWebHashHistory, useRouter, useRoute } = VueRouter;
        const { createPinia, defineStore } = Pinia;
        const { ElMessage, ElMessageBox, ElNotification } = ElementPlus;

        // --- å…¨å±€é…ç½® & å·¥å…·å‡½æ•° (ä½¿ç”¨å…¬å…±æ¨¡å—) ---
        const { API_BASE_URL, PLACEHOLDER_COVER, PLACEHOLDER_BANNER, PLACEHOLDER_AVATAR,
            handleImgError, formatTime, createHttpClient } = window.LibraryCommon;

        // HTTP è¯·æ±‚å°è£… (ä½¿ç”¨å…¬å…±æ¨¡å—)
        const http = createHttpClient('user_token_pro', 'user_info_pro');

        // --- åç«¯ API ---
        const api = {
            // ç™»å½•
            async login(data) {
                const result = await http.post('/auth/login', data);
                return {
                    token: result.token,
                    user: {
                        id: result.user.id,
                        username: result.user.username,
                        role: result.user.role,
                        avatar: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'
                    }
                };
            },
            // æ³¨å†Œ
            async register(data) {
                return await http.post('/auth/register', data);
            },
            // è·å–å›¾ä¹¦åˆ—è¡¨
            async getBooks(params = {}) {
                const queryParams = {
                    page: 1,
                    size: 100
                };
                if (params.keyword) queryParams.keyword = params.keyword;
                if (params.categoryId) queryParams.categoryId = params.categoryId;

                const result = await http.get('/books', queryParams);
                // æ˜ å°„å­—æ®µï¼šåç«¯ -> å‰ç«¯
                let list = (result.list || []).map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    categoryName: book.categoryName,
                    stock: book.availableCount,
                    cover: book.coverUrl || PLACEHOLDER_COVER,
                    price: book.price,
                    rating: 9.0 + Math.random() * 0.9, // åç«¯æš‚æ— è¯„åˆ†å­—æ®µ
                    desc: book.description,
                    date: book.createdAt ? book.createdAt.split('T')[0] : ''
                }));

                // æ’åº
                if (params.type === 'new') {
                    list = list.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                if (params.type === 'hot') {
                    list = list.sort((a, b) => b.rating - a.rating);
                }

                return list;
            },
            // è·å–åˆ†ç±»
            async getCategories() {
                return await http.get('/categories');
            },
            // è·å–æ–°ä¹¦æ¨è
            async getNewArrivals(days = 30, limit = 10) {
                const result = await http.get('/books/new-arrivals', { days, limit });
                return (result || []).map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    categoryName: book.categoryName,
                    stock: book.availableCount,
                    cover: book.coverUrl || PLACEHOLDER_COVER,
                    price: book.price,
                    rating: 9.0 + Math.random() * 0.9,
                    desc: book.description,
                    date: book.createdAt ? book.createdAt.split('T')[0] : ''
                }));
            },
            // è·å–çƒ­é—¨å›¾ä¹¦
            async getPopularBooks(limit = 10) {
                const result = await http.get('/books/popular', { limit });
                return (result || []).map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    categoryId: book.categoryId,
                    categoryName: book.categoryName,
                    stock: book.availableCount,
                    cover: book.coverUrl || PLACEHOLDER_COVER,
                    price: book.price,
                    rating: 9.0 + Math.random() * 0.9,
                    desc: book.description,
                    date: book.createdAt ? book.createdAt.split('T')[0] : ''
                }));
            },
            // è·å–å·²å‘å¸ƒå…¬å‘Šåˆ—è¡¨
            async getPublishedAnnouncements(page = 1, size = 10) {
                return await http.get('/announcements/published', { page, size });
            },
            // è·å–æœ€æ–°å…¬å‘Š
            async getLatestAnnouncements(limit = 5) {
                return await http.get('/announcements/latest', { limit });
            },
            // è·å–å…¬å‘Šè¯¦æƒ…
            async getAnnouncementById(id) {
                return await http.get(`/announcements/${id}`);
            },
            // å€Ÿä¹¦
            async borrowBook(bookId, userId) {
                await http.post('/borrows', { bookId });
            },
            // è¿˜ä¹¦
            async returnBook(id) {
                await http.post(`/borrows/${id}/return`);
            },
            // è·å–æˆ‘çš„å€Ÿé˜…è®°å½•
            async getMyBorrows(userId) {
                const result = await http.get('/borrows/my', { page: 1, size: 100 });
                return (result.list || []).map(record => ({
                    id: record.id,
                    bookId: record.bookId,
                    bookTitle: record.bookTitle,
                    userId: record.userId,
                    cover: record.bookCoverUrl || PLACEHOLDER_COVER,
                    author: record.bookAuthor || '',
                    borrowDate: record.borrowDate ? record.borrowDate.split('T')[0] : '',
                    returnDate: record.returnDate ? record.returnDate.split('T')[0] : null,
                    dueDate: record.dueDate ? record.dueDate.split('T')[0] : '',
                    status: record.statusDesc,
                    // æ–°å¢ç»­å€Ÿå’Œç½šæ¬¾ä¿¡æ¯
                    renewCount: record.renewCount || 0,
                    maxRenewCount: 2,
                    overdueDays: record.overdueDays || 0,
                    fineAmount: record.fineAmount || 0,
                    finePaid: record.finePaid || false,
                    overdue: record.overdue || false
                }));
            },
            // ç»­å€Ÿå›¾ä¹¦
            async renewBook(id) {
                return await http.post(`/borrows/${id}/renew`);
            },
            // ç¼´çº³ç½šæ¬¾
            async payFine(id) {
                return await http.post(`/borrows/${id}/pay-fine`);
            },
            // è¯„è®ºç›¸å…³ API
            async getReviews(limit = 6) {
                // è·å–æœ€æ–°è¯„è®ºï¼ˆé¦–é¡µå±•ç¤ºï¼‰
                const result = await http.get('/reviews/latest', { limit });
                return (result || []).map(r => ({
                    id: r.id,
                    bookId: r.bookId,
                    userId: r.userId,
                    username: r.username,
                    avatar: r.avatar || PLACEHOLDER_AVATAR,
                    rating: r.rating,
                    content: r.content,
                    date: r.createdAt ? r.createdAt.split(' ')[0] : '',
                    likes: r.likes,
                    bookTitle: r.bookTitle
                }));
            },
            async getBookReviews(bookId, page = 1, size = 10) {
                const result = await http.get(`/reviews/book/${bookId}`, { page, size });
                return {
                    list: (result.list || []).map(r => ({
                        id: r.id,
                        bookId: r.bookId,
                        userId: r.userId,
                        username: r.username,
                        avatar: r.avatar || PLACEHOLDER_AVATAR,
                        rating: r.rating,
                        content: r.content,
                        date: r.createdAt ? r.createdAt.split(' ')[0] : '',
                        likes: r.likes,
                        bookTitle: r.bookTitle
                    })),
                    total: result.total || 0,
                    avgRating: result.avgRating || 0,
                    reviewCount: result.reviewCount || 0
                };
            },
            async getMyReviews() {
                const result = await http.get('/reviews/my');
                return (result || []).map(r => ({
                    id: r.id,
                    bookId: r.bookId,
                    userId: r.userId,
                    username: r.username,
                    avatar: r.avatar || PLACEHOLDER_AVATAR,
                    rating: r.rating,
                    content: r.content,
                    date: r.createdAt ? r.createdAt.split(' ')[0] : '',
                    likes: r.likes,
                    bookTitle: r.bookTitle,
                    bookAuthor: r.bookAuthor,
                    bookCoverUrl: r.bookCoverUrl
                }));
            },
            async addReview(review) {
                const result = await http.post('/reviews', {
                    bookId: review.bookId,
                    rating: review.rating,
                    content: review.content
                });
                return result;
            },
            async deleteReview(id) {
                return await http.delete(`/reviews/${id}`);
            },
            async likeReview(id) {
                return await http.post(`/reviews/${id}/like`);
            },
            // ç³»ç»Ÿé…ç½®
            async getConfig() {
                return JSON.parse(localStorage.getItem('lib_sys_config_v3')) || {
                    sysName: 'æ™ºæ…§å›¾ä¹¦ - äº‘ç«¯ä¹¦åŸ Pro',
                    allowRegister: true,
                    maintenance: false
                };
            },
            // æ”¶è—ç›¸å…³
            async addFavorite(bookId, remark = '') {
                return await http.post(`/favorites/${bookId}`, { remark });
            },
            async removeFavorite(bookId) {
                return await http.delete(`/favorites/${bookId}`);
            },
            async getMyFavorites(page = 1, size = 100) {
                const result = await http.get('/favorites', { page, size });
                return (result.list || []).map(fav => ({
                    id: fav.id,
                    bookId: fav.bookId,
                    bookTitle: fav.bookTitle,
                    bookAuthor: fav.bookAuthor,
                    cover: fav.bookCoverUrl || PLACEHOLDER_COVER,
                    categoryName: fav.categoryName,
                    createdAt: fav.createdAt ? fav.createdAt.split('T')[0] : '',
                    remark: fav.remark
                }));
            },
            async checkFavorite(bookId) {
                return await http.get(`/favorites/check/${bookId}`);
            },
            // é€šçŸ¥ç›¸å…³ API
            async getNotifications(params = { page: 0, size: 20 }) {
                const result = await http.get('/notifications', params);
                const typeMap = {
                    'DUE_REMINDER': { label: 'åˆ°æœŸæé†’', color: 'warning' },
                    'OVERDUE_NOTICE': { label: 'é€¾æœŸé€šçŸ¥', color: 'danger' },
                    'RETURN_SUCCESS': { label: 'å½’è¿˜æˆåŠŸ', color: 'success' },
                    'BORROW_SUCCESS': { label: 'å€Ÿé˜…æˆåŠŸ', color: 'success' },
                    'FINE_NOTICE': { label: 'ç½šæ¬¾é€šçŸ¥', color: 'danger' },
                    'SYSTEM': { label: 'ç³»ç»Ÿé€šçŸ¥', color: 'info' }
                };
                return {
                    list: (result.content || []).map(n => ({
                        id: n.id,
                        title: n.title,
                        content: n.content,
                        type: typeMap[n.type]?.color || 'info',
                        typeLabel: typeMap[n.type]?.label || 'é€šçŸ¥',
                        read: n.isRead,
                        borrowRecordId: n.borrowRecordId,
                        time: n.createdAt ? formatTime(n.createdAt) : ''
                    })),
                    total: result.totalElements || 0
                };
            },
            async getUnreadCount() {
                const result = await http.get('/notifications/unread-count');
                return result.count || 0;
            },
            async markNotificationRead(id) {
                await http.put(`/notifications/${id}/read`);
            },
            async markAllNotificationsRead() {
                await http.put('/notifications/read-all');
            },
            // ä¿®æ”¹å¯†ç 
            async changePassword(data) {
                await http.post('/auth/change-password', data);
            },
            // é¢„çº¦ç›¸å…³ API
            async reserveBook(bookId) {
                return await http.post(`/reservations/${bookId}`);
            },
            async cancelReservation(id) {
                return await http.delete(`/reservations/${id}`);
            },
            async getMyReservations(page = 1, size = 100) {
                const result = await http.get('/reservations/my', { page, size });
                return (result.list || []).map(r => ({
                    id: r.id,
                    bookId: r.bookId,
                    bookTitle: r.bookTitle,
                    bookAuthor: r.bookAuthor,
                    bookCoverUrl: r.bookCoverUrl || PLACEHOLDER_COVER,
                    status: r.status,
                    statusDesc: r.statusDesc,
                    queuePosition: r.queuePosition,
                    notifiedAt: r.notifiedAt,
                    expiresAt: r.expiresAt ? r.expiresAt.split('T')[0] : null,
                    createdAt: r.createdAt ? r.createdAt.split('T')[0] : ''
                }));
            },
            async getMyActiveReservations() {
                const result = await http.get('/reservations/my/active');
                return result || [];
            },
            async checkReservation(bookId) {
                return await http.get(`/reservations/check/${bookId}`);
            },
            async getQueueLength(bookId) {
                const result = await http.get(`/reservations/queue/${bookId}`);
                return result.queueLength || 0;
            },
            // ç½šæ¬¾ç›¸å…³ API
            async getFineRules() {
                return await http.get('/config/fine-rules');
            },
            async getMyFines(params = {}) {
                const result = await http.get('/fines/me', params);
                return {
                    list: (result.list || []).map(r => ({
                        id: r.id,
                        bookTitle: r.bookTitle,
                        overdueDays: r.overdueDays,
                        amount: r.amount,
                        status: r.status,
                        statusText: r.statusText,
                        paidAt: r.paidAt,
                        waivedAt: r.waivedAt,
                        createdAt: r.createdAt
                    })),
                    total: result.total || 0
                };
            },
            async getMyUnpaidAmount() {
                return await http.get('/fines/me/unpaid-amount');
            },
            async payFineRecord(id) {
                return await http.post(`/fines/${id}/pay`);
            }
        };

        // formatTime å‡½æ•°å·²ä»å…¬å…±æ¨¡å—å¯¼å…¥,æ— éœ€é‡å¤å®šä¹‰

        const useUserStore = defineStore('user', () => {
            const token = ref(localStorage.getItem('user_token_pro') || '');
            const userInfo = ref(JSON.parse(localStorage.getItem('user_info_pro') || '{}'));
            const login = (data) => { token.value = data.token; userInfo.value = data.user; localStorage.setItem('user_token_pro', data.token); localStorage.setItem('user_info_pro', JSON.stringify(data.user)); };
            const logout = () => { token.value = ''; localStorage.removeItem('user_token_pro'); window.location.reload(); };
            return { token, userInfo, login, logout };
        });

        // --- ç»„ä»¶ ---
        const BookDetailModal = {
            props: ['visible', 'book', 'isFavorited', 'isReserved', 'queueLength'],
            emits: ['update:visible', 'borrow', 'toggleFavorite', 'reserve'],
            setup() { return { handleImgError }; },
            template: `
                <el-dialog :model-value="visible" @update:model-value="$emit('update:visible', $event)" width="800px" align-center class="custom-dialog" :show-close="false" append-to-body :destroy-on-close="true">
                    <div v-if="book" class="flex flex-col md:flex-row bg-white relative">
                        <!-- å…³é—­æŒ‰é’® -->
                        <button @click="$emit('update:visible', false)" class="icon-btn absolute top-4 right-4 z-50 w-8 h-8 rounded-full bg-gray-100/80 backdrop-blur hover:bg-gray-200 flex items-center justify-center"><el-icon><Close /></el-icon></button>

                        <!-- å·¦ä¾§å°é¢åŒºåŸŸ - ä»å·¦æ»‘å…¥ -->
                        <div class="modal-cover-section w-full md:w-5/12 h-64 md:h-[500px] relative modal-cover-wrapper">
                            <img :src="book.cover" @error="handleImgError" class="modal-cover-img w-full h-full object-cover">
                            <!-- æ¸å˜é®ç½© -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent md:bg-gradient-to-r md:from-transparent md:to-black/10"></div>
                            <!-- æ”¶è—æŒ‰é’® -->
                            <button @click="$emit('toggleFavorite', book)"
                                :class="['fav-btn-pulse absolute top-4 left-4 w-12 h-12 rounded-full flex items-center justify-center shadow-xl backdrop-blur-sm transition-all duration-300', isFavorited ? 'bg-red-500 text-white scale-110' : 'bg-white/80 text-gray-400 hover:text-red-500 hover:bg-white']">
                                <el-icon size="24"><Star /></el-icon>
                            </button>
                            <!-- è¯„åˆ†å¾½ç«  (ç§»åŠ¨ç«¯æ˜¾ç¤º) -->
                            <div class="md:hidden absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-sm font-bold text-amber-500 shadow-lg flex items-center gap-1">
                                <el-icon><StarFilled /></el-icon> {{book.rating}}
                            </div>
                        </div>

                        <!-- å³ä¾§ä¿¡æ¯åŒºåŸŸ - ä»å³æ»‘å…¥ -->
                        <div class="modal-info-section flex-1 p-8 md:p-10 flex flex-col h-auto md:h-[500px]">
                            <!-- æ ‡é¢˜å’Œè¯„åˆ†åŒºåŸŸ - ä»ä¸Šæ–¹è½ä¸‹ -->
                            <div class="modal-title-area hidden md:block">
                                <div class="flex items-center gap-3 mb-3">
                                    <el-tag effect="dark" round class="border-none bg-gradient-to-r from-indigo-600 to-purple-600 !px-4">ç²¾é€‰å›¾ä¹¦</el-tag>
                                    <div class="flex items-center text-amber-400 text-sm gap-1">
                                        <span class="text-base">â˜…â˜…â˜…â˜…â˜…</span>
                                        <span class="text-gray-500 font-bold ml-1">{{book.rating}}</span>
                                    </div>
                                </div>
                                <h2 class="text-3xl font-extrabold text-gray-900 mb-2 leading-tight tracking-tight">{{book.title}}</h2>
                                <p class="text-lg text-indigo-600 font-medium mb-6 flex items-center gap-2">
                                    <el-icon class="text-gray-400"><User /></el-icon>
                                    {{book.author}}
                                </p>
                            </div>

                            <!-- å†…å®¹ç®€ä»‹åŒºåŸŸ - æŸ”å’Œæ·¡å…¥ -->
                            <div class="modal-desc-area bg-gradient-to-br from-gray-50 to-slate-50 p-5 rounded-2xl mb-6 flex-1 overflow-y-auto border border-gray-100">
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <el-icon><Document /></el-icon> å†…å®¹ç®€ä»‹
                                </h4>
                                <p class="text-gray-600 leading-relaxed text-justify">{{book.desc}}</p>
                            </div>

                            <!-- åº•éƒ¨æ“ä½œåŒºåŸŸ - ä»ä¸‹æ–¹å‡èµ· -->
                            <div class="modal-action-area mt-auto">
                                <div class="flex items-end justify-between mb-6 pb-4 border-b border-gray-100">
                                    <div>
                                        <div class="text-xs text-gray-400 mb-1 uppercase tracking-wider">åº“å­˜çŠ¶æ€</div>
                                        <div :class="['font-bold text-lg flex items-center gap-2', book.stock>0 ? 'text-green-600':'text-red-500']">
                                            <span :class="['w-2 h-2 rounded-full', book.stock>0 ? 'bg-green-500 animate-pulse':'bg-red-500']"></span>
                                            {{book.stock > 0 ? 'ç°è´§ ' + book.stock + ' æœ¬' : 'æš‚æ—¶ç¼ºè´§'}}
                                        </div>
                                        <div v-if="book.stock <= 0 && queueLength > 0" class="text-xs text-orange-500 mt-1">
                                            å½“å‰ {{ queueLength }} äººé¢„çº¦ä¸­
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400 mb-1">å”®ä»·</div>
                                        <div class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">Â¥{{book.price}}</div>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <el-button @click="$emit('toggleFavorite', book)" :type="isFavorited ? 'danger' : 'default'" size="large" class="btn-press !h-14 !rounded-xl !px-6 !text-base">
                                        <el-icon class="mr-1"><Star /></el-icon>{{ isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—' }}
                                    </el-button>
                                    <!-- æœ‰åº“å­˜æ—¶æ˜¾ç¤ºå€Ÿé˜…æŒ‰é’® -->
                                    <el-button v-if="book.stock > 0" type="primary" size="large" class="btn-press flex-1 !h-14 !rounded-xl !text-lg !font-bold shadow-xl shadow-indigo-200" color="#4f46e5" @click="$emit('borrow', book)">
                                        <el-icon class="mr-2"><ShoppingCart /></el-icon>
                                        ç«‹å³å€Ÿé˜…
                                    </el-button>
                                    <!-- æ— åº“å­˜æ—¶æ˜¾ç¤ºé¢„çº¦æŒ‰é’® -->
                                    <el-button v-else type="warning" size="large" class="btn-press flex-1 !h-14 !rounded-xl !text-lg !font-bold shadow-xl shadow-orange-200" :disabled="isReserved" @click="$emit('reserve', book)">
                                        <el-icon class="mr-2"><Clock /></el-icon>
                                        {{ isReserved ? 'å·²é¢„çº¦' : 'é¢„çº¦æ­¤ä¹¦' }}
                                    </el-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </el-dialog>
            `
        };

        // æˆ‘çš„ç½šæ¬¾é¡µé¢
        const FinesPage = {
            template: `
                <div class="container mx-auto px-4 py-12 min-h-screen">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 animate__animated animate__fadeInLeft flex items-center gap-3">
                        <el-icon class="text-orange-500"><Coin /></el-icon> æˆ‘çš„ç½šæ¬¾
                    </h2>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
                            <div class="text-2xl font-bold text-red-600">{{ unpaidAmount }}å…ƒ</div>
                            <div class="text-gray-500 text-sm">å¾…ç¼´çº³é‡‘é¢</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
                            <div class="text-2xl font-bold text-green-600">{{ paidCount }}</div>
                            <div class="text-gray-500 text-sm">å·²ç¼´çº³è®°å½•</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
                            <div class="text-2xl font-bold text-blue-600">{{ totalCount }}</div>
                            <div class="text-gray-500 text-sm">æ€»è®°å½•æ•°</div>
                        </div>
                    </div>

                    <!-- ç½šæ¬¾è§„åˆ™è¯´æ˜ -->
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-2xl p-4 mb-6 border border-orange-100">
                        <div class="flex items-center gap-2 text-orange-700 font-semibold mb-2">
                            <el-icon><InfoFilled /></el-icon> ç½šæ¬¾è§„åˆ™
                        </div>
                        <div class="text-gray-600 text-sm space-y-1">
                            <p>æ¯æ—¥ç½šé‡‘ï¼š<span class="font-semibold text-orange-600">{{ fineRule.dailyAmount || 0.5 }}å…ƒ/å¤©</span></p>
                            <p>å°é¡¶é‡‘é¢ï¼š<span class="font-semibold text-orange-600">{{ fineRule.maxAmount == 0 ? 'æ— å°é¡¶' : fineRule.maxAmount + 'å…ƒ' }}</span></p>
                            <p v-if="fineRule.graceDays > 0">å…ç½šå¤©æ•°ï¼š<span class="font-semibold text-green-600">{{ fineRule.graceDays }}å¤©</span></p>
                        </div>
                    </div>

                    <!-- ç­›é€‰ -->
                    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                        <div class="flex gap-4 flex-wrap">
                            <el-select v-model="filters.status" placeholder="çŠ¶æ€" clearable style="width: 120px" @change="loadFines">
                                <el-option label="æœªç¼´çº³" value="UNPAID" />
                                <el-option label="å·²ç¼´çº³" value="PAID" />
                                <el-option label="å·²å…é™¤" value="WAIVED" />
                            </el-select>
                            <el-button @click="resetFilters">é‡ç½®</el-button>
                        </div>
                    </div>

                    <!-- ç½šæ¬¾åˆ—è¡¨ -->
                    <div class="space-y-4" v-loading="loading">
                        <div v-for="item in fines" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-6 hover:shadow-md transition-shadow">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-1">
                                    <h3 class="text-lg font-bold text-gray-800 truncate">{{ item.bookTitle }}</h3>
                                    <el-tag :type="getStatusType(item.status)" effect="dark" round size="small">{{ item.statusText }}</el-tag>
                                </div>
                                <div class="flex flex-wrap gap-4 text-xs text-gray-400">
                                    <span>é€¾æœŸå¤©æ•°: <span class="text-orange-500 font-medium">{{ item.overdueDays }}å¤©</span></span>
                                    <span>äº§ç”Ÿæ—¶é—´: {{ formatDate(item.createdAt) }}</span>
                                    <span v-if="item.paidAt">ç¼´è´¹æ—¶é—´: {{ formatDate(item.paidAt) }}</span>
                                    <span v-if="item.waivedAt">å…é™¤æ—¶é—´: {{ formatDate(item.waivedAt) }}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold" :class="item.status === 'UNPAID' ? 'text-red-500' : 'text-gray-400'">
                                    Â¥{{ item.amount }}
                                </div>
                                <el-button v-if="item.status === 'UNPAID'" type="warning" round size="small" class="mt-2" @click="payFine(item)">
                                    ç«‹å³ç¼´çº³
                                </el-button>
                            </div>
                        </div>
                        <div v-if="fines.length === 0 && !loading" class="text-center py-20">
                            <img src="https://illustrations.popsy.co/gray/success.svg" class="h-48 mx-auto mb-6 opacity-50">
                            <p class="text-gray-400">æš‚æ— ç½šæ¬¾è®°å½•ï¼Œç»§ç»­ä¿æŒå“¦ï¼</p>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div v-if="total > pageSize" class="flex justify-center mt-6">
                        <el-pagination
                            v-model:current-page="page"
                            v-model:page-size="pageSize"
                            :total="total"
                            :page-sizes="[10, 20, 50]"
                            layout="total, prev, pager, next"
                            @current-change="loadFines"
                        />
                    </div>
                </div>
            `,
            setup() {
                const loading = ref(false);
                const fines = ref([]);
                const page = ref(1);
                const pageSize = ref(10);
                const total = ref(0);
                const unpaidAmount = ref(0);
                const paidCount = ref(0);
                const totalCount = ref(0);
                const fineRule = ref({});
                const filters = reactive({ status: '' });

                const getStatusType = (status) => {
                    const map = { 'UNPAID': 'danger', 'PAID': 'success', 'WAIVED': 'warning' };
                    return map[status] || 'info';
                };

                const formatDate = (str) => {
                    if (!str) return '';
                    return str.replace('T', ' ').substring(0, 19);
                };

                const loadFines = async () => {
                    loading.value = true;
                    try {
                        const params = {
                            page: page.value,
                            size: pageSize.value,
                            ...(filters.status && { status: filters.status })
                        };
                        const result = await api.getMyFines(params);
                        fines.value = result.list || [];
                        total.value = result.total || 0;

                        // ç»Ÿè®¡
                        paidCount.value = fines.value.filter(f => f.status === 'PAID').length;
                        totalCount.value = result.total;
                    } catch (error) {
                        ElMessage.error(error.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadUnpaidAmount = async () => {
                    try {
                        unpaidAmount.value = await api.getMyUnpaidAmount() || 0;
                    } catch (error) {
                        console.error('è·å–æœªç¼´é‡‘é¢å¤±è´¥:', error);
                    }
                };

                const loadFineRule = async () => {
                    try {
                        fineRule.value = await api.getFineRules();
                    } catch (error) {
                        console.error('è·å–ç½šæ¬¾è§„åˆ™å¤±è´¥:', error);
                    }
                };

                const resetFilters = () => {
                    filters.status = '';
                    page.value = 1;
                    loadFines();
                };

                const payFine = async (item) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®è®¤ç¼´çº³ç½šæ¬¾ Â¥${item.amount} å—ï¼Ÿ`, 'ç¼´è´¹ç¡®è®¤', { type: 'warning' });
                        await api.payFineRecord(item.id);
                        ElMessage.success('ç½šæ¬¾å·²ç¼´çº³');
                        loadFines();
                        loadUnpaidAmount();
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                onMounted(() => {
                    loadFines();
                    loadUnpaidAmount();
                    loadFineRule();
                });

                return {
                    loading, fines, page, pageSize, total, unpaidAmount, paidCount, totalCount, fineRule, filters,
                    getStatusType, formatDate, loadFines, resetFilters, payFine
                };
            }
        };

        const CommunityPage = {
            template: `
                <div class="container mx-auto px-4 py-8 min-h-screen">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-8 animate__animated animate__fadeInDown">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                        <el-icon class="text-green-600"><ChatLineSquare /></el-icon> è¯»è€…ç¤¾åŒº
                                    </h2>
                                    <p class="text-gray-500 mt-1">åˆ†äº«ä½ çš„é˜…è¯»æ„Ÿæ‚Ÿï¼Œå‘ç°æ›´å¤šå¥½ä¹¦</p>
                                </div>
                                <el-button type="primary" size="large" icon="EditPen" class="btn-press !rounded-xl !px-6 shadow-lg shadow-green-100" color="#059669" @click="openPublish">
                                    å†™ä¹¦è¯„
                                </el-button>
                            </div>
                            <div class="space-y-6">
                                <div v-for="(review, index) in reviews" :key="review.id"
                                    class="review-card stagger-item bg-white p-6 rounded-2xl border border-gray-100"
                                    :style="{ animationDelay: (index * 0.1) + 's' }"
                                >
                                    <div class="flex items-start gap-4">
                                        <el-avatar :src="review.avatar" size="large" @error="e => handleImgError(e, 'avatar')" class="flex-shrink-0" />
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="font-bold text-gray-800 text-lg">{{ review.username }}</div>
                                                    <div class="flex items-center gap-2 text-sm text-gray-500 mt-0.5">
                                                        <span>è¯„</span> <span class="font-medium text-indigo-600 cursor-pointer hover:underline clickable" @click="goToBook(review.bookTitle)">ã€Š{{ review.bookTitle }}ã€‹</span>
                                                        <el-rate v-model="review.rating" disabled size="small" text-color="#ff9900" />
                                                        <span>{{ review.date }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-4 text-gray-700 leading-relaxed text-justify whitespace-pre-wrap">{{ review.content }}</div>
                                            <div class="mt-4 flex items-center gap-6">
                                                <button @click="like(review)" class="icon-btn flex items-center gap-1.5 text-gray-400 hover:text-red-500 transition-colors group">
                                                    <el-icon class="group-hover:scale-125 transition-transform"><sugar /></el-icon>
                                                    <span class="text-sm font-bold">{{ review.likes }} èµ</span>
                                                </button>
                                                <button @click="replyTo(review)" class="icon-btn flex items-center gap-1.5 text-gray-400 hover:text-indigo-500 transition-colors">
                                                    <el-icon><ChatDotRound /></el-icon>
                                                    <span class="text-sm font-bold">å›å¤</span>
                                                </button>
                                                <button class="icon-btn flex items-center gap-1.5 text-gray-400 hover:text-indigo-500 transition-colors ml-auto">
                                                    <el-icon><Share /></el-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-80 flex-shrink-0 space-y-6">
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-3xl p-6 border border-green-100 animate__animated animate__fadeInRight">
                                <h3 class="font-bold text-gray-800 mb-2">ğŸ‘‹ æ¬¢è¿åŠ å…¥</h3>
                                <p class="text-sm text-gray-600 mb-4">åœ¨è¿™é‡Œï¼Œæ¯ä¸€æœ¬ä¹¦éƒ½èƒ½æ‰¾åˆ°çŸ¥éŸ³ã€‚è¯·æ–‡æ˜å‘è¨€ï¼Œå…±åŒç»´æŠ¤è‰¯å¥½çš„ç¤¾åŒºæ°›å›´ã€‚</p>
                                <div class="flex -space-x-2 overflow-hidden">
                                    <img v-for="i in 5" :key="i" :src="'https://placehold.co/100x100?text='+i" class="inline-block h-8 w-8 rounded-full ring-2 ring-white" />
                                </div>
                                <div class="text-xs text-gray-400 mt-2">1,203 ä½ä¹¦å‹å·²åŠ å…¥</div>
                            </div>
                            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 animate__animated animate__fadeInRight" style="animation-delay: 0.1s">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><el-icon class="text-red-500"><CollectionTag /></el-icon> çƒ­é—¨è¯é¢˜</h3>
                                <div class="space-y-3">
                                    <div v-for="topic in topics" :key="topic" class="flex items-center justify-between text-sm text-gray-600 hover:text-indigo-600 cursor-pointer group">
                                        <span># {{ topic.title }}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full group-hover:bg-indigo-50 group-hover:text-indigo-600">{{ topic.count }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <el-dialog v-model="publishVisible" title="å‘å¸ƒä¹¦è¯„" width="500px" align-center class="!rounded-2xl">
                        <el-form :model="form" label-position="top">
                            <el-form-item label="é€‰æ‹©ä¹¦ç±">
                                <el-select v-model="form.bookId" placeholder="è¯·é€‰æ‹©ä½ çœ‹è¿‡çš„ä¹¦" filterable class="w-full">
                                    <el-option v-for="b in bookOptions" :key="b.id" :label="b.title" :value="b.id" />
                                </el-select>
                            </el-form-item>
                            <el-form-item label="è¯„ä»·ç­‰çº§">
                                <el-rate v-model="form.rating" show-text :texts="['æå·®', 'å¤±æœ›', 'ä¸€èˆ¬', 'æ¨è', 'åŠ›è']" />
                            </el-form-item>
                            <el-form-item label="ä¹¦è¯„å†…å®¹">
                                <el-input v-model="form.content" type="textarea" :rows="5" placeholder="å†™ä¸‹ä½ çš„çœŸçŸ¥ç¼è§..." />
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <span class="dialog-footer">
                                <el-button @click="publishVisible = false">å–æ¶ˆ</el-button>
                                <el-button type="primary" color="#059669" @click="submitReview" :disabled="!form.bookId || !form.content">å‘å¸ƒ</el-button>
                            </span>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const reviews = ref([]);
                const bookOptions = ref([]);
                const publishVisible = ref(false);
                const userStore = useUserStore();
                const router = useRouter();

                const form = reactive({ bookId: null, rating: 5, content: '' });
                const topics = [
                    { title: 'å¹´åº¦å¿…è¯»ä¹¦å•', count: '2.3w' },
                    { title: 'ç§‘å¹»è¿·é›†åˆ', count: '1.8w' },
                    { title: 'æ²»æ„ˆç³»æ–‡å­¦', count: '9k' },
                    { title: 'é«˜æ•ˆå­¦ä¹ æ³•', count: '5k' }
                ];

                const loadData = async () => {
                    reviews.value = await api.getReviews();
                    bookOptions.value = await api.getBooks(); // è·å–æ‰€æœ‰ä¹¦ç±ä¾›é€‰æ‹©
                };

                const openPublish = () => {
                    form.bookId = null; form.rating = 5; form.content = '';
                    publishVisible.value = true;
                };

                const submitReview = async () => {
                    const book = bookOptions.value.find(b => b.id === form.bookId);
                    if (!book) return;

                    await api.addReview({
                        bookId: book.id,
                        bookTitle: book.title,
                        userId: userStore.userInfo.id,
                        username: userStore.userInfo.username,
                        avatar: userStore.userInfo.avatar,
                        rating: form.rating,
                        content: form.content
                    });

                    ElMessage.success('å‘å¸ƒæˆåŠŸï¼');
                    publishVisible.value = false;
                    loadData(); // åˆ·æ–°åˆ—è¡¨
                };

                const like = async (review) => {
                    await api.likeReview(review.id);
                    review.likes++; // ä¹è§‚æ›´æ–°
                };

                const replyTo = (review) => {
                    // æ‰¾åˆ°è¯¥è¯„è®ºå¯¹åº”çš„ä¹¦ç±
                    const book = bookOptions.value.find(b => b.title === review.bookTitle);
                    form.bookId = book ? book.id : null;
                    form.rating = 5;
                    form.content = `@${review.username} `;
                    publishVisible.value = true;
                };

                const goToBook = (title) => {
                    router.push(`/collection?keyword=${title}`);
                };

                onMounted(loadData);
                return { reviews, topics, publishVisible, form, bookOptions, openPublish, submitReview, like, replyTo, goToBook, handleImgError };
            }
        };

        const CollectionPage = {
            components: { BookDetailModal },
            template: `
                <div class="container mx-auto px-4 py-8 min-h-screen">
                    <div class="flex items-center gap-4 mb-8 animate__animated animate__fadeInLeft">
                        <el-button circle size="large" @click="$router.go(-1)"><el-icon><Back /></el-icon></el-button>
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">{{ pageTitle }}</h2>
                            <p class="text-gray-500 text-sm mt-1">{{ pageSub }}</p>
                        </div>
                    </div>
                    
                    <div v-if="loading" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <el-skeleton v-for="i in 5" :key="i" animated><template #template><el-skeleton-item variant="image" class="h-64 rounded-2xl mb-2" /></template></el-skeleton>
                    </div>
                    <div v-else-if="books.length === 0" class="text-center py-20 text-gray-400">
                        <el-empty description="æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¹¦ç±" />
                        <el-button @click="$router.push('/store')">è¿”å›é¦–é¡µ</el-button>
                    </div>
                    <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-6 gap-y-10">
                        <div v-for="(book, index) in books" :key="book.id"
                            class="book-card stagger-item bg-white p-3 rounded-3xl cursor-pointer group relative"
                            :style="{ animationDelay: (index * 0.08) + 's' }"
                            @click="openDetail(book)">
                            <div class="relative rounded-2xl overflow-hidden aspect-[2/3] mb-4 shadow-sm bg-gray-100">
                                <img :src="book.cover" @error="handleImgError" class="cover-img w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                                    <el-button type="primary" round size="small" class="btn-press w-full !font-bold">æŸ¥çœ‹è¯¦æƒ…</el-button>
                                </div>
                                <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-0.5 rounded-lg text-xs font-bold text-amber-500 shadow-sm flex items-center"><el-icon class="mr-1"><StarFilled /></el-icon>{{book.rating}}</div>
                            </div>
                            <div class="px-1">
                                <h3 class="font-bold text-base text-gray-800 truncate mb-1 group-hover:text-indigo-600 transition-colors">{{book.title}}</h3>
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 truncate max-w-[60%]">{{book.author}}</p>
                                    <p class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">Â¥{{book.price}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <book-detail-modal v-model:visible="detailVisible" :book="selectedBook" :is-favorited="isFavorited" :is-reserved="isReserved" :queue-length="queueLength" @borrow="handleBorrow" @toggle-favorite="handleToggleFavorite" @reserve="handleReserve" />
                </div>
            `,
            setup() {
                const route = useRoute();
                const router = useRouter();
                const userStore = useUserStore();
                const books = ref([]);
                const loading = ref(false);
                const detailVisible = ref(false);
                const selectedBook = ref(null);
                const isFavorited = ref(false);
                const isReserved = ref(false);
                const queueLength = ref(0);

                const pageTitle = computed(() => {
                    if (route.query.type === 'new') return 'æ–°ä¹¦é€Ÿé€’';
                    if (route.query.type === 'hot') return 'æ¯æ—¥çƒ­æ¦œ';
                    if (route.query.author) return `ä½œè€…ï¼š${route.query.author}`;
                    if (route.query.keyword) return `æœç´¢ï¼š${route.query.keyword}`;
                    return 'ç²¾é€‰å›¾ä¹¦';
                });

                const pageSub = computed(() => {
                    if (route.query.type === 'new') return 'æ¢ç´¢æœ€æ–°ä¸Šæ¶çš„çŸ¥è¯†å®è—';
                    if (route.query.type === 'hot') return 'å¤§å®¶éƒ½åœ¨çœ‹çš„ç•…é”€å¥½ä¹¦';
                    return `å…±æ‰¾åˆ° ${books.value.length} æœ¬ç›¸å…³å›¾ä¹¦`;
                });

                const fetchData = async () => {
                    loading.value = true;
                    books.value = await api.getBooks(route.query);
                    loading.value = false;
                };

                const openDetail = async (b) => {
                    selectedBook.value = b;
                    detailVisible.value = true;
                    try {
                        const [favorited, reserved, queue] = await Promise.all([
                            api.checkFavorite(b.id).catch(() => false),
                            api.checkReservation(b.id).catch(() => false),
                            api.getQueueLength(b.id).catch(() => 0)
                        ]);
                        isFavorited.value = favorited;
                        isReserved.value = reserved;
                        queueLength.value = queue;
                    } catch (e) {
                        isFavorited.value = false;
                        isReserved.value = false;
                        queueLength.value = 0;
                    }
                };
                const handleToggleFavorite = async (book) => {
                    try {
                        if (isFavorited.value) {
                            await api.removeFavorite(book.id);
                            isFavorited.value = false;
                            ElMessage.success('å·²å–æ¶ˆæ”¶è—');
                        } else {
                            await api.addFavorite(book.id);
                            isFavorited.value = true;
                            ElMessage.success('æ”¶è—æˆåŠŸ');
                        }
                    } catch (e) {
                        ElMessage.error(e.message);
                    }
                };
                const handleBorrow = async (book) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šå€Ÿé˜…ã€Š${book.title}ã€‹å—ï¼Ÿ`, 'æç¤º', { type: 'info' });
                        await api.borrowBook(book.id, userStore.userInfo.id);
                        ElNotification({ title: 'å€Ÿé˜…æˆåŠŸ', type: 'success' });
                        detailVisible.value = false;
                        fetchData();
                    } catch { }
                };

                const handleReserve = async (book) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šé¢„çº¦ã€Š${book.title}ã€‹å—ï¼Ÿ\nå›¾ä¹¦å½’è¿˜åå°†é€šçŸ¥æ‚¨ï¼Œå±Šæ—¶è¯·åœ¨3å¤©å†…å‰å¾€å€Ÿé˜…ã€‚`, 'é¢„çº¦ç¡®è®¤', { type: 'info' });
                        await api.reserveBook(book.id);
                        isReserved.value = true;
                        queueLength.value += 1;
                        ElNotification({ title: 'é¢„çº¦æˆåŠŸ', message: `æ‚¨å·²æˆåŠŸé¢„çº¦ã€Š${book.title}ã€‹ï¼Œå½“å‰æ’é˜Ÿä½ç½®ï¼šç¬¬ ${queueLength.value} ä½`, type: 'success', duration: 5000 });
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                watch(() => route.query, fetchData, { immediate: true });
                return { books, loading, pageTitle, pageSub, detailVisible, selectedBook, isFavorited, isReserved, queueLength, openDetail, handleBorrow, handleToggleFavorite, handleReserve, handleImgError };
            }
        };

        const StoreHome = {
            components: { BookDetailModal },
            template: `
                <div class="pb-24">
                    <div class="relative w-full h-[520px] overflow-hidden mb-8 group">
                        <el-carousel trigger="click" height="520px" arrow="hover" :interval="5000">
                            <el-carousel-item v-for="(item, index) in banners" :key="index">
                                <div class="relative w-full h-full cursor-pointer" @click="handleBannerClick(item)">
                                    <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-transparent z-10"></div>
                                    <img :src="item.img" @error="e => handleImgError(e, 'banner')" class="w-full h-full object-cover transition-transform duration-[10s] ease-out group-hover:scale-105" />
                                    <div class="absolute bottom-0 left-0 w-full p-12 md:p-20 z-20 flex flex-col items-start animate__animated animate__fadeInLeft">
                                        <div class="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 tracking-widest uppercase">Featured</div>
                                        <h2 class="text-4xl md:text-6xl font-bold text-white mb-4 leading-tight drop-shadow-lg max-w-2xl">{{item.title}}</h2>
                                        <p class="text-lg md:text-xl text-gray-200 mb-8 max-w-xl font-light">{{item.sub}}</p>
                                        <el-button size="large" round class="!px-10 !h-14 !text-base !font-bold !border-none bg-white text-gray-900 hover:scale-105 transition-transform shadow-2xl">
                                            {{ item.btnText }} <el-icon class="ml-2"><Right /></el-icon>
                                        </el-button>
                                    </div>
                                </div>
                            </el-carousel-item>
                        </el-carousel>
                    </div>

                    <div class="container mx-auto px-4 -mt-16 relative z-30 mb-16">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div v-for="(feat, idx) in featured" :key="idx"
                                @click="handleFeaturedClick(feat)"
                                class="bg-white p-6 rounded-2xl shadow-xl flex items-center gap-4 cursor-pointer hover:-translate-y-2 transition-transform animate__animated animate__fadeInUp"
                                :style="{ animationDelay: idx * 0.1 + 's' }"
                            >
                                <div :class="['w-14 h-14 rounded-full flex items-center justify-center text-white text-2xl shadow-lg', feat.color]">
                                    <el-icon><component :is="feat.icon" /></el-icon>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">{{feat.title}}</h4>
                                    <p class="text-sm text-gray-500">{{feat.sub}}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å…¬å‘ŠåŒºåŸŸ -->
                    <div v-if="announcements.length > 0" class="container mx-auto px-4 mb-12">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <el-icon class="text-orange-500"><Bell /></el-icon> å›¾ä¹¦é¦†å…¬å‘Š
                            </h2>
                            <el-button link type="primary" size="small" @click="showAllAnnouncements = true">æŸ¥çœ‹æ›´å¤š</el-button>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-2xl p-4 border border-orange-100">
                            <div class="flex flex-col gap-3">
                                <div v-for="ann in announcements.slice(0, 3)" :key="ann.id"
                                    class="bg-white rounded-xl p-4 cursor-pointer hover:shadow-md transition-shadow flex items-start gap-3"
                                    @click="openAnnouncementDetail(ann)">
                                    <div :class="['w-8 h-8 rounded-lg flex items-center justify-center shrink-0', getAnnouncementTypeClass(ann.type)]">
                                        <el-icon size="16"><component :is="getAnnouncementIcon(ann.type)" /></el-icon>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <el-tag v-if="ann.pinned" type="danger" size="small" effect="plain">ç½®é¡¶</el-tag>
                                            <el-tag :type="getAnnouncementTagType(ann.type)" size="small" effect="plain">{{ ann.typeDesc }}</el-tag>
                                            <span class="font-semibold text-gray-800 truncate">{{ ann.title }}</span>
                                        </div>
                                        <p class="text-sm text-gray-500 truncate">{{ ann.content }}</p>
                                    </div>
                                    <span class="text-xs text-gray-400 shrink-0">{{ formatAnnouncementDate(ann.createdAt) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–°ä¹¦æ¨èåŒºåŸŸ -->
                    <div v-if="newArrivals.length > 0" class="container mx-auto px-4 mb-12">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <el-icon class="text-blue-500"><Timer /></el-icon> æ–°ä¹¦ä¸Šæ¶
                            </h2>
                            <el-button link type="primary" size="small" @click="$router.push('/collection?type=new')">æŸ¥çœ‹æ›´å¤š</el-button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <div v-for="(book, index) in newArrivals" :key="book.id"
                                class="book-card stagger-item bg-white p-3 rounded-2xl cursor-pointer group"
                                :style="{ animationDelay: (index * 0.05) + 's' }"
                                @click="openDetail(book)">
                                <div class="relative rounded-xl overflow-hidden aspect-[2/3] mb-3 shadow-sm bg-gray-100">
                                    <img :src="book.cover" @error="handleImgError" class="cover-img w-full h-full object-cover">
                                    <div class="absolute top-2 left-2 bg-blue-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">NEW</div>
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                        <el-button type="primary" round size="small" class="btn-press !font-bold">æŸ¥çœ‹</el-button>
                                    </div>
                                </div>
                                <div class="px-1">
                                    <h3 class="font-bold text-sm text-gray-800 truncate group-hover:text-indigo-600 transition-colors">{{book.title}}</h3>
                                    <p class="text-xs text-gray-400 truncate">{{book.author}}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="container mx-auto px-4 flex flex-col lg:flex-row gap-10">
                        <div class="flex-1 min-w-0">
                            <div class="sticky top-20 z-40 bg-white/95 backdrop-blur-xl p-4 rounded-2xl shadow-lg border border-gray-100 mb-8">
                                <div class="flex flex-col gap-4">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-sm font-bold text-gray-500 flex items-center gap-2">
                                            <el-icon class="text-indigo-500"><Grid /></el-icon> å›¾ä¹¦åˆ†ç±»
                                        </h3>
                                        <div class="relative w-64">
                                            <el-input v-model="query.keyword" placeholder="æœç´¢ä¹¦å..." class="!rounded-full" prefix-icon="Search" clearable @input="fetchData" size="default" />
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <button @click="toggleCat(null)" :class="['cat-btn px-4 py-2 rounded-xl text-sm font-semibold', !query.categoryId ? 'bg-gradient-to-r from-gray-800 to-gray-900 text-white shadow-lg shadow-gray-300' : 'bg-gray-50 text-gray-600 hover:bg-gray-100 hover:shadow-md']">
                                            <span class="flex items-center gap-1"><el-icon><Folder /></el-icon> å…¨éƒ¨</span>
                                        </button>
                                        <button v-for="c in categories" :key="c.id" @click="toggleCat(c.id)" :class="['cat-btn px-4 py-2 rounded-xl text-sm font-semibold', query.categoryId === c.id ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg shadow-indigo-200' : 'bg-gray-50 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 hover:shadow-md']">
                                            {{c.name}}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><el-icon class="text-indigo-600"><Collection /></el-icon> é¦†è—èµ„æº</h2>
                                <span class="text-sm text-gray-400">å…± {{books.length}} æœ¬å›¾ä¹¦</span>
                            </div>

                            <div v-if="loading" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                 <el-skeleton v-for="i in 8" :key="i" animated><template #template><el-skeleton-item variant="image" class="h-64 rounded-2xl mb-2" /><el-skeleton-item variant="p" class="w-2/3" /></template></el-skeleton>
                            </div>

                            <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-10">
                                <div v-for="(book, index) in books" :key="book.id"
                                    class="book-card stagger-item bg-white p-3 rounded-3xl cursor-pointer group relative"
                                    :style="{ animationDelay: (index * 0.08) + 's' }"
                                    @click="openDetail(book)">
                                    <div class="relative rounded-2xl overflow-hidden aspect-[2/3] mb-4 shadow-sm bg-gray-100">
                                        <img :src="book.cover" @error="handleImgError" class="cover-img w-full h-full object-cover">
                                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                                            <el-button type="primary" round size="small" class="btn-press w-full !font-bold">æŸ¥çœ‹è¯¦æƒ…</el-button>
                                        </div>
                                        <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-0.5 rounded-lg text-xs font-bold text-amber-500 shadow-sm flex items-center"><el-icon class="mr-1"><StarFilled /></el-icon>{{book.rating.toFixed(1)}}</div>
                                    </div>
                                    <div class="px-1">
                                        <h3 class="font-bold text-base text-gray-800 truncate mb-1 group-hover:text-indigo-600 transition-colors">{{book.title}}</h3>
                                        <div class="flex justify-between items-center">
                                            <p class="text-xs text-gray-500 truncate max-w-[60%]">{{book.author}}</p>
                                            <p class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">Â¥{{book.price}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="w-full lg:w-80 flex-shrink-0">
                            <div class="lg:sticky lg:top-24 space-y-6">
                            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 animate__animated animate__fadeInRight">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><el-icon class="text-orange-500"><Trophy /></el-icon> æ¯æ—¥çƒ­æ¦œ</h3>
                                    <el-button link type="primary" size="small" @click="$router.push('/collection?type=hot')">å…¨éƒ¨</el-button>
                                </div>
                                <div class="space-y-5">
                                    <div v-for="(book, idx) in hotBooks" :key="book.id"
                                        class="clickable flex items-center gap-4 cursor-pointer group p-2 -mx-2 rounded-xl hover:bg-gray-50"
                                        @click="openDetail(book)">
                                        <div class="relative w-12 h-16 flex-shrink-0 rounded overflow-hidden shadow-sm">
                                            <img :src="book.cover" @error="handleImgError" class="w-full h-full object-cover">
                                            <div v-if="idx < 3" :class="['absolute top-0 left-0 w-5 h-5 flex items-center justify-center text-[10px] font-bold text-white rounded-br-lg', idx===0?'bg-yellow-400':idx===1?'bg-gray-400':'bg-amber-600']">{{idx+1}}</div>
                                            <div v-else class="absolute top-0 left-0 w-5 h-5 flex items-center justify-center text-[10px] font-bold text-gray-500 bg-gray-100 rounded-br-lg">{{idx+1}}</div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="text-sm font-bold text-gray-800 truncate group-hover:text-indigo-600 transition-colors">{{book.title}}</h4>
                                            <div class="flex items-center gap-2 mt-1"><div class="flex text-[10px] text-amber-400">â˜…â˜…â˜…â˜…â˜…</div><span class="text-xs text-gray-400">{{book.rating.toFixed(1)}}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl shadow-lg p-6 text-white relative overflow-hidden group cursor-pointer clickable animate__animated animate__fadeInRight"
                                style="animation-delay: 0.1s"
                                @click="$router.push('/collection?keyword=Java')"
                            >
                                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                                <div class="relative z-10">
                                    <div class="text-xs font-bold text-indigo-200 mb-2 uppercase tracking-widest">Category Spotlight</div>
                                    <h3 class="text-xl font-bold mb-1">è®¡ç®—æœºç¼–ç¨‹</h3>
                                    <p class="text-sm text-indigo-100 mb-4 opacity-80">æ¢ç´¢ç¼–ç¨‹ä¸–ç•Œçš„æ— é™å¯èƒ½ã€‚</p>
                                    <el-button size="small" round class="btn-press !bg-white/20 !border-none !text-white hover:!bg-white/30">æŸ¥çœ‹æ›´å¤š</el-button>
                                </div>
                                <img src="https://images.unsplash.com/photo-1461749280684-dccba630e2f6?auto=format&fit=crop&w=200&q=80" class="absolute -bottom-4 -right-4 w-24 h-24 object-cover rounded-full border-4 border-indigo-500/30 opacity-50 group-hover:opacity-100 group-hover:scale-110 transition-all">
                            </div>

                            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 animate__animated animate__fadeInRight" style="animation-delay: 0.2s">
                                <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2"><el-icon><PriceTag /></el-icon> çƒ­é—¨åˆ†ç±»</h3>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="cat in categories.slice(0, 8)" :key="cat.id"
                                        @click="$router.push('/collection?categoryId=' + cat.id)"
                                        class="cat-btn px-3 py-1.5 bg-gray-100 text-gray-600 text-xs font-medium rounded-full hover:bg-indigo-50 hover:text-indigo-600 cursor-pointer"
                                    ># {{cat.name}}</span>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    <book-detail-modal v-model:visible="detailVisible" :book="selectedBook" :is-favorited="isFavorited" :is-reserved="isReserved" :queue-length="queueLength" @borrow="handleBorrow" @toggle-favorite="handleToggleFavorite" @reserve="handleReserve" />

                    <!-- å…¬å‘Šè¯¦æƒ…å¼¹çª— -->
                    <el-dialog v-model="announcementDetailVisible" title="å…¬å‘Šè¯¦æƒ…" width="550px" class="announcement-dialog">
                        <div v-if="currentAnnouncement" class="space-y-4">
                            <div class="flex items-center gap-2 flex-wrap">
                                <el-tag v-if="currentAnnouncement.pinned" type="danger" size="small">ç½®é¡¶</el-tag>
                                <el-tag :type="getAnnouncementTagType(currentAnnouncement.type)" size="small">{{ currentAnnouncement.typeDesc }}</el-tag>
                                <span class="text-xs text-gray-400">{{ formatAnnouncementDate(currentAnnouncement.createdAt) }}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">{{ currentAnnouncement.title }}</h3>
                            <div class="text-sm text-gray-500">å‘å¸ƒè€…ï¼š{{ currentAnnouncement.publisherName }}</div>
                            <el-divider />
                            <div class="text-gray-700 whitespace-pre-wrap leading-relaxed max-h-96 overflow-y-auto">{{ currentAnnouncement.content }}</div>
                        </div>
                    </el-dialog>

                    <!-- å…¬å‘Šåˆ—è¡¨å¼¹çª— -->
                    <el-dialog v-model="showAllAnnouncements" title="å…¨éƒ¨å…¬å‘Š" width="700px" class="announcement-dialog">
                        <div class="space-y-3 max-h-[500px] overflow-y-auto">
                            <div v-for="ann in allAnnouncements" :key="ann.id"
                                class="bg-gray-50 rounded-xl p-4 cursor-pointer hover:bg-gray-100 transition-colors flex items-start gap-3"
                                @click="openAnnouncementDetail(ann); showAllAnnouncements = false;">
                                <div :class="['w-10 h-10 rounded-lg flex items-center justify-center shrink-0', getAnnouncementTypeClass(ann.type)]">
                                    <el-icon size="18"><component :is="getAnnouncementIcon(ann.type)" /></el-icon>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <el-tag v-if="ann.pinned" type="danger" size="small" effect="plain">ç½®é¡¶</el-tag>
                                        <el-tag :type="getAnnouncementTagType(ann.type)" size="small" effect="plain">{{ ann.typeDesc }}</el-tag>
                                        <span class="font-semibold text-gray-800">{{ ann.title }}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 line-clamp-2">{{ ann.content }}</p>
                                </div>
                                <span class="text-xs text-gray-400 shrink-0 whitespace-nowrap">{{ formatAnnouncementDate(ann.createdAt) }}</span>
                            </div>
                            <div v-if="allAnnouncements.length === 0" class="text-center text-gray-400 py-8">
                                æš‚æ— å…¬å‘Š
                            </div>
                        </div>
                        <div v-if="announcementTotal > 10" class="mt-4 flex justify-center">
                            <el-pagination
                                v-model:current-page="announcementPage"
                                :page-size="10"
                                :total="announcementTotal"
                                layout="prev, pager, next"
                                @current-change="loadAllAnnouncements"
                            />
                        </div>
                    </el-dialog>
                </div>
            `,
            setup() {
                const books = ref([]);
                const loading = ref(false);
                const query = reactive({ categoryId: null, keyword: '' });
                const detailVisible = ref(false);
                const selectedBook = ref(null);
                const isFavorited = ref(false);
                const isReserved = ref(false);
                const queueLength = ref(0);
                const router = useRouter();
                const userStore = useUserStore();
                const categories = ref([]);
                const newArrivals = ref([]);

                // å…¬å‘Šç›¸å…³æ•°æ®
                const announcements = ref([]);
                const allAnnouncements = ref([]);
                const announcementPage = ref(1);
                const announcementTotal = ref(0);
                const showAllAnnouncements = ref(false);
                const announcementDetailVisible = ref(false);
                const currentAnnouncement = ref(null);

                const hotBooks = computed(() => [...books.value].sort((a, b) => b.rating - a.rating).slice(0, 5));

                const banners = [
                    { img: 'https://images.unsplash.com/photo-1507842217121-9e93a5f63a81?auto=format&fit=crop&w=1600&q=80', title: 'å¼€å¯é˜…è¯»æ–°çºªå…ƒ', sub: 'åœ¨è¿™ä¸ªæ•°å­—æ—¶ä»£ï¼Œé‡æ‹¾çº¸å¢¨ä¹¦é¦™çš„æ„ŸåŠ¨ã€‚', btnText: 'æµè§ˆå…¨éƒ¨', link: '/collection' },
                    { img: 'https://images.unsplash.com/photo-1491841550275-ad7854e35ca6?auto=format&fit=crop&w=1600&q=80', title: 'æ–°ä¹¦é€Ÿé€’', sub: 'æœ¬æœˆæ–°å¢ 500+ æœ¬å¥½ä¹¦ï¼Œç­‰ä½ æ¥å€Ÿã€‚', btnText: 'æŸ¥çœ‹æ–°ä¹¦', link: '/collection?type=new' },
                    { img: 'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&w=1600&q=80', title: 'æ¢ç´¢æœªçŸ¥è¾¹ç•Œ', sub: 'ç²¾é€‰ç§‘æŠ€ä¸äººæ–‡å¥½ä¹¦ã€‚', btnText: 'çƒ­é—¨æ¨è', link: '/collection?type=hot' }
                ];

                const featured = [
                    { title: 'æ–°ä¹¦é€Ÿé€’', sub: 'æœ€æ–°ä¸Šæ¶å›¾ä¹¦', icon: 'Timer', color: 'bg-blue-500', link: '/collection?type=new' },
                    { title: 'å€Ÿé˜…æ’è¡Œ', sub: 'å¤§å®¶éƒ½åœ¨çœ‹', icon: 'Trophy', color: 'bg-orange-500', link: '/collection?type=hot' },
                    { title: 'è¯»è€…ç¤¾åŒº', sub: 'åˆ†äº«é˜…è¯»æ„Ÿæ‚Ÿ', icon: 'ChatLineSquare', color: 'bg-green-500', link: '/community' },
                ];

                const loadCategories = async () => {
                    try {
                        const tree = await api.getCategories();
                        // å±•å¹³åˆ†ç±»æ ‘
                        const flatten = (cats, result = []) => {
                            cats.forEach(cat => {
                                result.push({ id: cat.id, name: cat.name });
                                if (cat.children && cat.children.length) flatten(cat.children, result);
                            });
                            return result;
                        };
                        categories.value = flatten(tree);
                    } catch (e) {
                        console.error('åŠ è½½åˆ†ç±»å¤±è´¥', e);
                        // ä½¿ç”¨é»˜è®¤åˆ†ç±»
                        categories.value = [
                            { id: 1, name: 'æ–‡å­¦' }, { id: 2, name: 'è®¡ç®—æœº' }, { id: 3, name: 'å†å²' }, { id: 4, name: 'ç»æµ' }
                        ];
                    }
                };

                const loadNewArrivals = async () => {
                    try {
                        newArrivals.value = await api.getNewArrivals(30, 6);
                    } catch (e) {
                        console.error('åŠ è½½æ–°ä¹¦æ¨èå¤±è´¥', e);
                        newArrivals.value = [];
                    }
                };

                // åŠ è½½æœ€æ–°å…¬å‘Šï¼ˆé¦–é¡µå±•ç¤ºï¼‰
                const loadAnnouncements = async () => {
                    try {
                        announcements.value = await api.getLatestAnnouncements(5);
                    } catch (e) {
                        console.error('åŠ è½½å…¬å‘Šå¤±è´¥', e);
                        announcements.value = [];
                    }
                };

                // åŠ è½½å…¨éƒ¨å…¬å‘Šï¼ˆåˆ†é¡µï¼‰
                const loadAllAnnouncements = async () => {
                    try {
                        const result = await api.getPublishedAnnouncements(announcementPage.value, 10);
                        allAnnouncements.value = result.list || [];
                        announcementTotal.value = result.total || 0;
                    } catch (e) {
                        console.error('åŠ è½½å…¨éƒ¨å…¬å‘Šå¤±è´¥', e);
                        allAnnouncements.value = [];
                    }
                };

                // æ‰“å¼€å…¬å‘Šè¯¦æƒ…
                const openAnnouncementDetail = (ann) => {
                    currentAnnouncement.value = ann;
                    announcementDetailVisible.value = true;
                };

                // å…¬å‘Šç±»å‹æ ·å¼
                const getAnnouncementTypeClass = (type) => {
                    const map = {
                        NORMAL: 'bg-blue-100 text-blue-600',
                        IMPORTANT: 'bg-red-100 text-red-600',
                        ACTIVITY: 'bg-green-100 text-green-600',
                        MAINTENANCE: 'bg-yellow-100 text-yellow-700'
                    };
                    return map[type] || 'bg-gray-100 text-gray-600';
                };

                const getAnnouncementTagType = (type) => {
                    const map = { NORMAL: 'info', IMPORTANT: 'danger', ACTIVITY: 'success', MAINTENANCE: 'warning' };
                    return map[type] || 'info';
                };

                const getAnnouncementIcon = (type) => {
                    const map = { NORMAL: 'Bell', IMPORTANT: 'Warning', ACTIVITY: 'Present', MAINTENANCE: 'Tools' };
                    return map[type] || 'Bell';
                };

                const formatAnnouncementDate = (str) => {
                    if (!str) return '';
                    const date = new Date(str);
                    const now = new Date();
                    const diff = now - date;
                    const days = Math.floor(diff / 86400000);
                    if (days === 0) return 'ä»Šå¤©';
                    if (days === 1) return 'æ˜¨å¤©';
                    if (days < 7) return `${days}å¤©å‰`;
                    return str.split('T')[0];
                };

                // ç›‘å¬å…¨éƒ¨å…¬å‘Šå¼¹çª—æ‰“å¼€
                watch(showAllAnnouncements, (val) => {
                    if (val) {
                        announcementPage.value = 1;
                        loadAllAnnouncements();
                    }
                });

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        books.value = await api.getBooks(query);
                    } catch (e) {
                        ElMessage.error(e.message);
                    } finally {
                        loading.value = false;
                    }
                };
                const toggleCat = (id) => { query.categoryId = query.categoryId === id ? null : id; fetchData(); };
                const openDetail = async (b) => {
                    selectedBook.value = b;
                    detailVisible.value = true;
                    // å¹¶è¡Œæ£€æŸ¥æ”¶è—å’Œé¢„çº¦çŠ¶æ€
                    try {
                        const [favorited, reserved, queue] = await Promise.all([
                            api.checkFavorite(b.id).catch(() => false),
                            api.checkReservation(b.id).catch(() => false),
                            api.getQueueLength(b.id).catch(() => 0)
                        ]);
                        isFavorited.value = favorited;
                        isReserved.value = reserved;
                        queueLength.value = queue;
                    } catch (e) {
                        isFavorited.value = false;
                        isReserved.value = false;
                        queueLength.value = 0;
                    }
                };
                const handleToggleFavorite = async (book) => {
                    try {
                        if (isFavorited.value) {
                            await api.removeFavorite(book.id);
                            isFavorited.value = false;
                            ElMessage.success('å·²å–æ¶ˆæ”¶è—');
                        } else {
                            await api.addFavorite(book.id);
                            isFavorited.value = true;
                            ElMessage.success('æ”¶è—æˆåŠŸ');
                        }
                    } catch (e) {
                        ElMessage.error(e.message);
                    }
                };
                const handleBorrow = async (book) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šå€Ÿé˜…ã€Š${book.title}ã€‹å—ï¼Ÿ`);
                        await api.borrowBook(book.id, userStore.userInfo.id);
                        ElNotification({ title: 'å€Ÿé˜…æˆåŠŸ', type: 'success' });
                        detailVisible.value = false;
                        fetchData();
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                const handleReserve = async (book) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šé¢„çº¦ã€Š${book.title}ã€‹å—ï¼Ÿ\nå›¾ä¹¦å½’è¿˜åå°†é€šçŸ¥æ‚¨ï¼Œå±Šæ—¶è¯·åœ¨3å¤©å†…å‰å¾€å€Ÿé˜…ã€‚`, 'é¢„çº¦ç¡®è®¤', { type: 'info' });
                        await api.reserveBook(book.id);
                        isReserved.value = true;
                        queueLength.value += 1;
                        ElNotification({ title: 'é¢„çº¦æˆåŠŸ', message: `æ‚¨å·²æˆåŠŸé¢„çº¦ã€Š${book.title}ã€‹ï¼Œå½“å‰æ’é˜Ÿä½ç½®ï¼šç¬¬ ${queueLength.value} ä½`, type: 'success', duration: 5000 });
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                const handleBannerClick = (item) => { if (item.link) router.push(item.link); };
                const handleFeaturedClick = (item) => { if (item.link) router.push(item.link); };

                onMounted(() => {
                    fetchData();
                    loadCategories();
                    loadNewArrivals();
                    loadAnnouncements();
                });
                return {
                    books, loading, query, banners, featured, categories, newArrivals,
                    detailVisible, selectedBook, isFavorited, isReserved, queueLength, hotBooks,
                    // å…¬å‘Šç›¸å…³
                    announcements, allAnnouncements, announcementPage, announcementTotal,
                    showAllAnnouncements, announcementDetailVisible, currentAnnouncement,
                    openAnnouncementDetail, loadAllAnnouncements,
                    getAnnouncementTypeClass, getAnnouncementTagType, getAnnouncementIcon, formatAnnouncementDate,
                    // æ“ä½œæ–¹æ³•
                    toggleCat, fetchData, openDetail, handleBorrow, handleToggleFavorite,
                    handleReserve, handleBannerClick, handleFeaturedClick, handleImgError
                };
            }
        };

        const StoreShelf = {
            components: { BookDetailModal },
            template: `
                <div class="container mx-auto px-4 py-12 min-h-screen">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 animate__animated animate__fadeInLeft">æˆ‘çš„ä¹¦æ¶</h2>
                    <div class="grid gap-6 animate__animated animate__fadeInUp">
                        <div v-for="item in list" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-6 hover:shadow-md transition-shadow">
                            <div class="w-20 h-28 flex-shrink-0 rounded-lg overflow-hidden bg-gray-200">
                                <img :src="item.cover" @error="handleImgError" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-1">
                                    <h3 class="text-xl font-bold text-gray-800 truncate">{{item.bookTitle}}</h3>
                                    <el-tag :type="getStatusType(item)" effect="dark" round size="small">{{item.status}}</el-tag>
                                    <el-tag v-if="item.overdue && item.status === 'å€Ÿé˜…ä¸­'" type="danger" effect="dark" round size="small">å·²é€¾æœŸ</el-tag>
                                </div>
                                <p class="text-gray-500 text-sm mb-2">ä½œè€…: {{item.author || 'æœªçŸ¥'}}</p>
                                <div class="flex flex-wrap gap-4 text-xs text-gray-400">
                                    <span>å€Ÿé˜…æ—¥æœŸ: {{item.borrowDate}}</span>
                                    <span>åº”è¿˜æ—¥æœŸ: {{item.dueDate}}</span>
                                    <span v-if="item.returnDate">å½’è¿˜æ—¥æœŸ: {{item.returnDate}}</span>
                                </div>
                                <!-- ç»­å€Ÿå’Œç½šæ¬¾ä¿¡æ¯ -->
                                <div class="flex flex-wrap gap-4 mt-2">
                                    <span v-if="item.status === 'å€Ÿé˜…ä¸­'" class="text-xs px-2 py-1 rounded-full" :class="item.renewCount >= 2 ? 'bg-gray-100 text-gray-500' : 'bg-blue-50 text-blue-600'">
                                        å·²ç»­å€Ÿ {{item.renewCount}}/2 æ¬¡
                                    </span>
                                    <span v-if="item.fineAmount > 0" class="text-xs px-2 py-1 rounded-full" :class="item.finePaid ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'">
                                        ç½šæ¬¾ Â¥{{item.fineAmount.toFixed(2)}} {{ item.finePaid ? '(å·²ç¼´)' : '(æœªç¼´)' }}
                                    </span>
                                    <span v-if="item.overdueDays > 0" class="text-xs px-2 py-1 rounded-full bg-orange-50 text-orange-600">
                                        é€¾æœŸ {{item.overdueDays}} å¤©
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <!-- å€Ÿé˜…ä¸­çŠ¶æ€çš„æ“ä½œæŒ‰é’® -->
                                <template v-if="item.status === 'å€Ÿé˜…ä¸­'">
                                    <!-- æœ‰æœªç¼´ç½šæ¬¾æ—¶æ˜¾ç¤ºç¼´è´¹æŒ‰é’® -->
                                    <el-button v-if="item.fineAmount > 0 && !item.finePaid" type="warning" round class="btn-press !px-6 shadow-lg shadow-orange-100" @click="payFine(item)">
                                        ç¼´çº³ç½šæ¬¾ Â¥{{item.fineAmount.toFixed(2)}}
                                    </el-button>
                                    <!-- å¯ç»­å€Ÿæ—¶æ˜¾ç¤ºç»­å€ŸæŒ‰é’® -->
                                    <el-button v-if="item.renewCount < 2 && !item.overdue" type="success" round class="btn-press !px-6 shadow-lg shadow-green-100" @click="renew(item)">
                                        ç»­å€Ÿ30å¤©
                                    </el-button>
                                    <!-- å½’è¿˜æŒ‰é’® -->
                                    <el-button type="primary" round class="btn-press !px-6 shadow-lg shadow-indigo-100" @click="ret(item)">å½’è¿˜å›¾ä¹¦</el-button>
                                </template>
                                <!-- å·²å½’è¿˜çŠ¶æ€ -->
                                <template v-else>
                                    <div class="text-green-600 font-bold text-sm px-4">å·²å½’è¿˜</div>
                                    <el-button v-if="item.fineAmount > 0 && !item.finePaid" type="warning" size="small" round @click="payFine(item)">
                                        ç¼´çº³ç½šæ¬¾
                                    </el-button>
                                </template>
                            </div>
                        </div>
                        <div v-if="list.length === 0" class="text-center py-20">
                            <img src="https://illustrations.popsy.co/gray/surr-reading.svg" class="h-48 mx-auto mb-6 opacity-50">
                            <p class="text-gray-400">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»ä¹¦åŸçœ‹çœ‹å§</p>
                            <el-button class="mt-4" @click="$router.push('/store')">å»é€›é€›</el-button>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const list = ref([]);
                const userStore = useUserStore();
                const load = async () => list.value = await api.getMyBorrows(userStore.userInfo.id);

                const getStatusType = (item) => {
                    if (item.status === 'å·²å½’è¿˜') return 'success';
                    if (item.overdue) return 'danger';
                    return 'warning';
                };

                const ret = async (row) => {
                    await ElMessageBox.confirm(`ç¡®è®¤å½’è¿˜ã€Š${row.bookTitle}ã€‹?`);
                    await api.returnBook(row.id);
                    ElMessage.success('å·²å½’è¿˜');
                    load();
                };

                const renew = async (row) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®è®¤ç»­å€Ÿã€Š${row.bookTitle}ã€‹ï¼Ÿç»­å€Ÿåè¿˜ä¹¦æ—¥æœŸå°†å»¶é•¿30å¤©ã€‚`, 'ç»­å€Ÿç¡®è®¤', { type: 'info' });
                        await api.renewBook(row.id);
                        ElMessage.success('ç»­å€ŸæˆåŠŸï¼è¿˜ä¹¦æ—¥æœŸå·²å»¶é•¿30å¤©');
                        load();
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                const payFine = async (row) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®è®¤ç¼´çº³ç½šæ¬¾ Â¥${row.fineAmount.toFixed(2)} å—ï¼Ÿ`, 'ç¼´è´¹ç¡®è®¤', { type: 'warning' });
                        await api.payFine(row.id);
                        ElMessage.success('ç½šæ¬¾å·²ç¼´çº³');
                        load();
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };

                onMounted(load);
                return { list, ret, renew, payFine, getStatusType, handleImgError };
            }
        };

        const FavoritesPage = {
            template: `
                <div class="container mx-auto px-4 py-12 min-h-screen">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 animate__animated animate__fadeInLeft flex items-center gap-3">
                            <el-icon class="text-red-500"><Star /></el-icon> æˆ‘çš„æ”¶è—
                        </h2>
                        <span class="text-gray-400">å…± {{ list.length }} æœ¬</span>
                    </div>
                    <div v-if="loading" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <el-skeleton v-for="i in 5" :key="i" animated><template #template><el-skeleton-item variant="image" class="h-64 rounded-2xl mb-2" /></template></el-skeleton>
                    </div>
                    <div v-else-if="list.length === 0" class="text-center py-20">
                        <img src="https://illustrations.popsy.co/gray/heart.svg" class="h-48 mx-auto mb-6 opacity-50">
                        <p class="text-gray-400 mb-4">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å›¾ä¹¦</p>
                        <el-button type="primary" @click="$router.push('/store')">å»é€›é€›ä¹¦åŸ</el-button>
                    </div>
                    <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-6 gap-y-10">
                        <div v-for="(item, index) in list" :key="item.id"
                            class="book-card stagger-item bg-white p-3 rounded-3xl cursor-pointer group relative"
                            :style="{ animationDelay: (index * 0.08) + 's' }">
                            <div class="relative rounded-2xl overflow-hidden aspect-[2/3] mb-4 shadow-sm bg-gray-100">
                                <img :src="item.cover" @error="handleImgError" class="cover-img w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4 gap-2">
                                    <el-button type="primary" round class="btn-press w-full !h-10 !font-bold !text-sm !px-0 !mx-0" @click="$router.push('/store')">æŸ¥çœ‹è¯¦æƒ…</el-button>
                                    <el-button type="danger" round class="btn-press w-full !h-10 !font-bold !text-sm !px-0 !mx-0" @click.stop="removeFav(item)">å–æ¶ˆæ”¶è—</el-button>
                                </div>
                                <button @click.stop="removeFav(item)" class="icon-btn absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600">
                                    <el-icon><Star /></el-icon>
                                </button>
                            </div>
                            <div class="px-1">
                                <h3 class="font-bold text-base text-gray-800 truncate mb-1 group-hover:text-indigo-600 transition-colors">{{ item.bookTitle }}</h3>
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 truncate max-w-[60%]">{{ item.bookAuthor }}</p>
                                    <p class="text-xs text-gray-400">{{ item.createdAt }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const list = ref([]);
                const loading = ref(false);
                const load = async () => {
                    loading.value = true;
                    try {
                        list.value = await api.getMyFavorites();
                    } catch (e) {
                        ElMessage.error(e.message);
                    } finally {
                        loading.value = false;
                    }
                };
                const removeFav = async (item) => {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šå–æ¶ˆæ”¶è—ã€Š${item.bookTitle}ã€‹å—ï¼Ÿ`);
                        await api.removeFavorite(item.bookId);
                        ElMessage.success('å·²å–æ¶ˆæ”¶è—');
                        load();
                    } catch (e) {
                        if (e !== 'cancel' && e.message) ElMessage.error(e.message);
                    }
                };
                onMounted(load);
                return { list, loading, removeFav, handleImgError };
            }
        };

        const Login = {
            template: `
                <div class="min-h-screen flex relative bg-gray-900 overflow-hidden">
                    <div class="absolute inset-0 z-0">
                        <img src="https://images.unsplash.com/photo-1481627834876-b7833e8f5570?auto=format&fit=crop&w=2000&q=80" @error="e => handleImgError(e, 'banner')" class="w-full h-full object-cover opacity-40">
                    </div>
                    <div class="relative z-10 w-full flex items-center justify-center p-4">
                        <div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/20 w-full max-w-md text-center animate__animated animate__fadeInDown">
                            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                <el-icon class="text-indigo-600" size="32"><Reading /></el-icon>
                            </div>
                            <h1 class="text-3xl font-bold text-white mb-2">{{ sysName }}</h1>
                            <p class="text-gray-300 mb-8 font-light">æ¢ç´¢ Â· å‘ç° Â· é˜…è¯»</p>

                            <el-form v-if="showLoginForm" :model="loginForm" class="text-left mb-4">
                                <el-form-item>
                                    <el-input v-model="loginForm.username" placeholder="ç”¨æˆ·å" prefix-icon="User" size="large" class="!rounded-xl" />
                                </el-form-item>
                                <el-form-item>
                                    <el-input v-model="loginForm.password" type="password" placeholder="å¯†ç " prefix-icon="Lock" size="large" show-password class="!rounded-xl" />
                                </el-form-item>
                            </el-form>

                            <div class="flex flex-col gap-3">
                                <el-button v-if="showLoginForm" color="#4f46e5" size="large" class="btn-press w-full !h-14 !text-lg !font-bold !rounded-xl !px-0 !mx-0 shadow-xl shadow-indigo-900/50" :loading="loading" @click="handleLogin">
                                    ç™»å½•
                                </el-button>
                                <el-button v-else color="#4f46e5" size="large" class="btn-press w-full !h-14 !text-lg !font-bold !rounded-xl !px-0 !mx-0 shadow-xl shadow-indigo-900/50" @click="showLoginForm = true">
                                    è¿›å…¥å›¾ä¹¦é¦†
                                </el-button>
                                <el-button size="large" class="btn-press w-full !h-14 !text-lg !font-bold !rounded-xl !px-0 !mx-0 !bg-white/20 !border-white/30 !text-white hover:!bg-white/30" @click="handleRegister">
                                    æ³¨å†Œæ–°è´¦å·
                                </el-button>
                            </div>
                            <div class="mt-4 text-gray-400 text-xs">
                                æç¤ºï¼šå¯ä½¿ç”¨ admin/admin123 ç™»å½•
                            </div>
                        </div>
                    </div>

                    <!-- æ³¨å†Œå¼¹çª— -->
                    <el-dialog v-model="registerVisible" title="æ³¨å†Œæ–°è´¦å·" width="400px" align-center class="!rounded-2xl">
                        <el-form :model="registerForm" label-position="top">
                            <el-form-item label="ç”¨æˆ·å" required>
                                <el-input v-model="registerForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
                            </el-form-item>
                            <el-form-item label="å¯†ç " required>
                                <el-input v-model="registerForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " show-password />
                            </el-form-item>
                            <el-form-item label="çœŸå®å§“å">
                                <el-input v-model="registerForm.realName" placeholder="è¯·è¾“å…¥çœŸå®å§“å" />
                            </el-form-item>
                            <el-form-item label="é‚®ç®±">
                                <el-input v-model="registerForm.email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
                            </el-form-item>
                            <el-form-item label="æ‰‹æœºå·">
                                <el-input v-model="registerForm.phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="registerVisible = false">å–æ¶ˆ</el-button>
                            <el-button type="primary" :loading="registerLoading" @click="submitRegister">æ³¨å†Œ</el-button>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const router = useRouter(); const store = useUserStore();
                const sysName = ref('äº‘ç«¯ä¹¦åŸ');
                const config = ref({});
                const showLoginForm = ref(true);
                const loading = ref(false);
                const loginForm = reactive({ username: '', password: '' });

                const registerVisible = ref(false);
                const registerLoading = ref(false);
                const registerForm = reactive({
                    username: '',
                    password: '',
                    realName: '',
                    email: '',
                    phone: ''
                });

                onMounted(async () => {
                    try {
                        const c = await api.getConfig();
                        if (c) {
                            sysName.value = c.sysName;
                            config.value = c;
                        }
                    } catch (e) {
                        console.log('è·å–é…ç½®å¤±è´¥', e);
                    }
                });

                const handleLogin = async () => {
                    if (!loginForm.username || !loginForm.password) {
                        return ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    }
                    loading.value = true;
                    try {
                        const res = await api.login(loginForm);
                        store.login(res);
                        ElMessage.success('ç™»å½•æˆåŠŸ');
                        router.push('/store');
                    } catch (e) {
                        ElMessage.error(e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const handleRegister = () => {
                    if (config.value && config.value.allowRegister === false) {
                        ElMessage.error('æŠ±æ­‰ï¼Œç›®å‰ç³»ç»Ÿæš‚åœå¼€æ”¾æ³¨å†Œ');
                    } else {
                        registerVisible.value = true;
                    }
                };

                const submitRegister = async () => {
                    if (!registerForm.username || !registerForm.password) {
                        return ElMessage.warning('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
                    }
                    registerLoading.value = true;
                    try {
                        await api.register(registerForm);
                        ElNotification({
                            title: 'æ³¨å†ŒæˆåŠŸ',
                            message: 'æ‚¨çš„è´¦å·å·²æäº¤å®¡æ ¸ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åå³å¯ç™»å½•ã€‚',
                            type: 'success',
                            duration: 6000
                        });
                        registerVisible.value = false;
                        loginForm.username = registerForm.username;
                        loginForm.password = '';
                        // æ¸…ç©ºæ³¨å†Œè¡¨å•
                        Object.assign(registerForm, { username: '', password: '', realName: '', email: '', phone: '' });
                    } catch (e) {
                        ElMessage.error(e.message);
                    } finally {
                        registerLoading.value = false;
                    }
                };

                return { handleLogin, handleRegister, sysName, handleImgError, showLoginForm, loading, loginForm, registerVisible, registerForm, registerLoading, submitRegister };
            }
        };

        const UserLayout = {
            template: `
                <div class="min-h-screen flex flex-col">
                    <header class="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center transition-all">
                        <div class="flex items-center gap-3 cursor-pointer group" @click="$router.push('/store')">
                            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:scale-105 transition-transform">
                                <el-icon size="20"><Reading /></el-icon>
                            </div>
                            <span class="text-xl font-extrabold text-gray-800 tracking-tight">{{ sysName }} <span class="text-indigo-600">Pro</span></span>
                        </div>
                        <div class="flex items-center gap-6">
                            <nav class="hidden md:flex items-center gap-6">
                                <router-link to="/store" class="font-bold text-gray-500 hover:text-indigo-600 transition-colors" active-class="text-indigo-600 !font-extrabold">é¦–é¡µ</router-link>
                                <router-link to="/shelf" class="font-bold text-gray-500 hover:text-indigo-600 transition-colors" active-class="text-indigo-600 !font-extrabold">æˆ‘çš„ä¹¦æ¶</router-link>
                                <router-link to="/fines" class="font-bold text-gray-500 hover:text-orange-500 transition-colors" active-class="text-orange-500 !font-extrabold">æˆ‘çš„ç½šæ¬¾</router-link>
                                <router-link to="/favorites" class="font-bold text-gray-500 hover:text-red-500 transition-colors" active-class="text-red-500 !font-extrabold">æˆ‘çš„æ”¶è—</router-link>
                                <router-link to="/community" class="font-bold text-gray-500 hover:text-indigo-600 transition-colors" active-class="text-indigo-600 !font-extrabold">ç¤¾åŒº</router-link>
                            </nav>
                            <div class="w-px h-6 bg-gray-300 hidden md:block"></div>
                            <div class="flex items-center gap-3">
                                <!-- é€šçŸ¥é“ƒé“› -->
                                <el-popover placement="bottom" :width="360" trigger="click">
                                    <template #reference>
                                        <button class="icon-btn relative w-10 h-10 rounded-full bg-gray-100 hover:bg-indigo-50 flex items-center justify-center text-gray-500 hover:text-indigo-600 transition-all">
                                            <el-icon size="20"><Bell /></el-icon>
                                            <span v-if="unreadCount > 0" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center px-1 border-2 border-white">
                                                {{ unreadCount > 99 ? '99+' : unreadCount }}
                                            </span>
                                        </button>
                                    </template>
                                    <div class="p-2">
                                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                                <el-icon class="text-indigo-500"><Bell /></el-icon> æ¶ˆæ¯é€šçŸ¥
                                            </h3>
                                            <el-button link type="primary" size="small" @click="markAllRead" :disabled="!unreadCount">å…¨éƒ¨å·²è¯»</el-button>
                                        </div>
                                        <div v-if="notifications.length === 0" class="text-center py-8 text-gray-400">
                                            <el-icon size="48" class="mb-2 opacity-50"><Bell /></el-icon>
                                            <p>æš‚æ— æ–°æ¶ˆæ¯</p>
                                        </div>
                                        <ul v-else class="space-y-1 max-h-80 overflow-y-auto">
                                            <li v-for="n in notifications" :key="n.id"
                                                @click="viewNotification(n)"
                                                :class="['p-3 rounded-xl cursor-pointer transition-all', n.read ? 'bg-gray-50 opacity-70' : 'bg-indigo-50 hover:bg-indigo-100']">
                                                <div class="flex items-start gap-3">
                                                    <div :class="['w-2 h-2 mt-2 rounded-full flex-shrink-0',
                                                        n.type === 'danger' ? 'bg-red-500' :
                                                        n.type === 'warning' ? 'bg-orange-500' :
                                                        n.type === 'success' ? 'bg-green-500' : 'bg-blue-500']"></div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <span class="font-bold text-gray-800 text-sm truncate">{{ n.title }}</span>
                                                            <el-tag size="small" :type="n.type" effect="plain" round>{{ n.typeLabel }}</el-tag>
                                                        </div>
                                                        <p class="text-xs text-gray-500 truncate">{{ n.content }}</p>
                                                        <p class="text-xs text-gray-400 mt-1">{{ n.time }}</p>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </el-popover>

                                <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                                <el-dropdown trigger="click" @command="handleUserCommand">
                                    <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity">
                                        <el-avatar :size="36" :src="userStore.userInfo.avatar" @error="e => handleImgError(e, 'avatar')" class="border-2 border-white shadow-sm" />
                                        <span class="text-sm font-bold text-gray-600 hidden md:inline">{{ userStore.userInfo.username }}</span>
                                        <el-icon class="text-gray-400"><ArrowDown /></el-icon>
                                    </div>
                                    <template #dropdown>
                                        <el-dropdown-menu>
                                            <el-dropdown-item command="password">
                                                <el-icon class="mr-2"><Lock /></el-icon>ä¿®æ”¹å¯†ç 
                                            </el-dropdown-item>
                                            <el-dropdown-item divided command="logout">
                                                <el-icon class="mr-2 text-red-500"><SwitchButton /></el-icon>
                                                <span class="text-red-500">é€€å‡ºç™»å½•</span>
                                            </el-dropdown-item>
                                        </el-dropdown-menu>
                                    </template>
                                </el-dropdown>
                            </div>
                        </div>
                    </header>

                    <!-- é€šçŸ¥è¯¦æƒ…å¼¹çª— -->
                    <el-dialog v-model="showNotifyDetail" title="æ¶ˆæ¯è¯¦æƒ…" width="450px" align-center class="!rounded-2xl" append-to-body>
                        <div v-if="selectedNotify" class="space-y-4">
                            <div class="flex items-center gap-3">
                                <el-tag :type="selectedNotify.type" effect="dark" round>{{ selectedNotify.typeLabel }}</el-tag>
                                <span class="text-gray-400 text-sm">{{ selectedNotify.time }}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">{{ selectedNotify.title }}</h3>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <p class="text-gray-600 leading-relaxed whitespace-pre-wrap">{{ selectedNotify.content }}</p>
                            </div>
                            <div v-if="selectedNotify.borrowRecordId" class="pt-2">
                                <el-button type="primary" round @click="goToShelf">æŸ¥çœ‹å€Ÿé˜…è®°å½•</el-button>
                            </div>
                        </div>
                        <template #footer>
                            <el-button type="primary" round @click="showNotifyDetail = false">å…³é—­</el-button>
                        </template>
                    </el-dialog>

                    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
                    <el-dialog v-model="showPasswordDialog" title="ä¿®æ”¹å¯†ç " width="400px" align-center class="!rounded-2xl" append-to-body :close-on-click-modal="false">
                        <el-form :model="passwordForm" label-position="top" ref="passwordFormRef">
                            <el-form-item label="å½“å‰å¯†ç " prop="oldPassword" required>
                                <el-input v-model="passwordForm.oldPassword" type="password" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " show-password prefix-icon="Lock" />
                            </el-form-item>
                            <el-form-item label="æ–°å¯†ç " prop="newPassword" required>
                                <el-input v-model="passwordForm.newPassword" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆ6-20ä½ï¼‰" show-password prefix-icon="Key" />
                            </el-form-item>
                            <el-form-item label="ç¡®è®¤æ–°å¯†ç " prop="confirmPassword" required>
                                <el-input v-model="passwordForm.confirmPassword" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " show-password prefix-icon="Key" />
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="showPasswordDialog = false" round>å–æ¶ˆ</el-button>
                            <el-button type="primary" @click="submitPasswordChange" :loading="passwordLoading" round>ç¡®è®¤ä¿®æ”¹</el-button>
                        </template>
                    </el-dialog>

                    <main class="flex-1">
                        <router-view v-slot="{ Component }">
                            <transition name="el-fade-in-linear" mode="out-in">
                                <component :is="Component" />
                            </transition>
                        </router-view>
                    </main>
                    <footer class="bg-white py-10 mt-12 border-t border-gray-100">
                        <div class="text-center text-gray-400 text-sm">
                            <p class="mb-2 font-bold text-gray-300 text-lg">{{ sysName }} Pro</p>
                            <p>&copy; 2025 Designed for Readers.</p>
                        </div>
                    </footer>
                </div>
            `,
            setup() {
                const router = useRouter();
                const sysName = ref('äº‘ç«¯ä¹¦åŸ');
                const userStore = useUserStore();

                // é€šçŸ¥ç›¸å…³çŠ¶æ€
                const notifications = ref([]);
                const unreadCount = ref(0);
                const showNotifyDetail = ref(false);
                const selectedNotify = ref(null);

                // ä¿®æ”¹å¯†ç ç›¸å…³çŠ¶æ€
                const showPasswordDialog = ref(false);
                const passwordLoading = ref(false);
                const passwordForm = reactive({
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                });

                // ç”¨æˆ·ä¸‹æ‹‰èœå•å‘½ä»¤å¤„ç†
                const handleUserCommand = (command) => {
                    if (command === 'password') {
                        // é‡ç½®è¡¨å•
                        passwordForm.oldPassword = '';
                        passwordForm.newPassword = '';
                        passwordForm.confirmPassword = '';
                        showPasswordDialog.value = true;
                    } else if (command === 'logout') {
                        userStore.logout();
                    }
                };

                // æäº¤å¯†ç ä¿®æ”¹
                const submitPasswordChange = async () => {
                    // å‰ç«¯éªŒè¯
                    if (!passwordForm.oldPassword) {
                        return ElMessage.warning('è¯·è¾“å…¥å½“å‰å¯†ç ');
                    }
                    if (!passwordForm.newPassword) {
                        return ElMessage.warning('è¯·è¾“å…¥æ–°å¯†ç ');
                    }
                    if (passwordForm.newPassword.length < 6 || passwordForm.newPassword.length > 20) {
                        return ElMessage.warning('æ–°å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´');
                    }
                    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
                        return ElMessage.warning('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    }
                    if (passwordForm.oldPassword === passwordForm.newPassword) {
                        return ElMessage.warning('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ');
                    }

                    passwordLoading.value = true;
                    try {
                        await api.changePassword(passwordForm);
                        ElMessage.success('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                        showPasswordDialog.value = false;
                        // å»¶è¿Ÿåé€€å‡ºç™»å½•
                        setTimeout(() => {
                            userStore.logout();
                        }, 1500);
                    } catch (e) {
                        ElMessage.error(e.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
                    } finally {
                        passwordLoading.value = false;
                    }
                };

                // åŠ è½½é€šçŸ¥åˆ—è¡¨
                const loadNotifications = async () => {
                    try {
                        const result = await api.getNotifications({ page: 0, size: 10 });
                        notifications.value = result.list;
                    } catch (e) {
                        console.error('åŠ è½½é€šçŸ¥å¤±è´¥:', e);
                    }
                };

                // åŠ è½½æœªè¯»æ•°é‡
                const loadUnreadCount = async () => {
                    try {
                        unreadCount.value = await api.getUnreadCount();
                    } catch (e) {
                        console.error('è·å–æœªè¯»æ•°é‡å¤±è´¥:', e);
                    }
                };

                // æŸ¥çœ‹é€šçŸ¥è¯¦æƒ…
                const viewNotification = async (n) => {
                    selectedNotify.value = n;
                    showNotifyDetail.value = true;
                    if (!n.read) {
                        try {
                            await api.markNotificationRead(n.id);
                            n.read = true;
                            unreadCount.value = Math.max(0, unreadCount.value - 1);
                        } catch (e) {
                            console.error('æ ‡è®°å·²è¯»å¤±è´¥:', e);
                        }
                    }
                };

                // å…¨éƒ¨æ ‡è®°å·²è¯»
                const markAllRead = async () => {
                    try {
                        await api.markAllNotificationsRead();
                        notifications.value.forEach(n => n.read = true);
                        unreadCount.value = 0;
                        ElMessage.success('å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»');
                    } catch (e) {
                        ElMessage.error('æ“ä½œå¤±è´¥: ' + e.message);
                    }
                };

                // è·³è½¬åˆ°ä¹¦æ¶
                const goToShelf = () => {
                    showNotifyDetail.value = false;
                    router.push('/shelf');
                };

                onMounted(async () => {
                    const c = await api.getConfig();
                    if (c) sysName.value = c.sysName;

                    // åŠ è½½é€šçŸ¥
                    await loadNotifications();
                    await loadUnreadCount();

                    // æ¯åˆ†é’Ÿåˆ·æ–°æœªè¯»æ•°é‡
                    setInterval(loadUnreadCount, 60000);
                });

                return {
                    userStore,
                    sysName,
                    handleImgError,
                    notifications,
                    unreadCount,
                    showNotifyDetail,
                    selectedNotify,
                    viewNotification,
                    markAllRead,
                    goToShelf,
                    // ä¿®æ”¹å¯†ç ç›¸å…³
                    showPasswordDialog,
                    passwordForm,
                    passwordLoading,
                    handleUserCommand,
                    submitPasswordChange
                };
            }
        };

        const Maintenance = {
            template: `
                <div class="h-screen flex flex-col items-center justify-center bg-gray-100 p-4 text-center">
                    <el-icon size="64" class="text-gray-400 mb-4"><Tools /></el-icon>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ç³»ç»Ÿç»´æŠ¤ä¸­</h1>
                    <p class="text-gray-500 max-w-md">ä¸ºäº†æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œç³»ç»Ÿæ­£åœ¨è¿›è¡Œå‡çº§ç»´æŠ¤ã€‚è¯·ç¨åå†è®¿é—®ã€‚</p>
                </div>
            `
        };

        const routes = [
            { path: '/login', component: Login },
            { path: '/maintenance', component: Maintenance },
            {
                path: '/', component: UserLayout, redirect: '/store', children: [
                    { path: 'store', component: StoreHome },
                    { path: 'shelf', component: StoreShelf },
                    { path: 'fines', component: FinesPage },
                    { path: 'favorites', component: FavoritesPage },
                    { path: 'collection', component: CollectionPage },
                    { path: 'community', component: CommunityPage }
                ]
            }
        ];
        const router = createRouter({ history: createWebHashHistory(), routes });

        // å…¨å±€è·¯ç”±å®ˆå«
        router.beforeEach(async (to, from, next) => {
            const config = await api.getConfig();
            if (config && config.maintenance && to.path !== '/maintenance') {
                return next('/maintenance');
            }
            if (!config.maintenance && to.path === '/maintenance') {
                return next('/login');
            }

            const s = useUserStore();
            if (to.path === '/login') return next();
            if (!s.token) return next('/login');
            next();
        });

        const app = createApp({ template: `<router-view></router-view>` });
        for (const [k, v] of Object.entries(ElementPlusIconsVue)) app.component(k, v);
        app.use(createPinia()).use(router).use(ElementPlus).mount('#app');
    </script>
</body>

</html>